<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Decomposing Changes over Time (Wooldridge 9.3)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .red-title {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 5px solid #a71e2a;
        }

        .red-title h1 {
            font-size: 2.3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .red-title p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .blue-concepts {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 25px;
        }

        .blue-concepts h3 {
            font-size: 1.7em;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .measures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }

        .measure-card {
            padding: 18px;
            border-radius: 15px;
            border: 3px solid;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .decomp-card  { background: linear-gradient(135deg, #28a745, #20c997); border-color:#1e7e34; color:white; }
        .comp-card    { background: linear-gradient(135deg, #6f42c1, #8e44ad); border-color:#563d7c; color:white; }
        .struct-card  { background: linear-gradient(135deg, #17a2b8, #138496); border-color:#117a8b; color:white; }
        .practice-card{ background: linear-gradient(135deg, #ffc107, #ff8800); border-color:#d39e00; color:#212529; }

        .measure-card h4 {
            font-size: 1.2em;
            margin-bottom: 10px;
            text-align: center;
        }

        .measure-card .formula {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 8px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-align: center;
            font-size: 0.85em;
        }

        .measure-card .description { margin-bottom: 10px; font-size:0.9em; }
        .measure-card .use-cases   { margin-bottom: 10px; font-style: italic; font-size:0.85em; }
        .measure-card .examples    { font-size:0.8em; border-top: 2px solid rgba(255,255,255,0.3); padding-top: 8px; }

        .interactive-section {
            padding: 25px;
            background: #f8f9fa;
        }

        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #007bff;
        }

        .scenario-display,
        .calculation-area {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .scenario-display { border-left: 5px solid #28a745; }
        .calculation-area { border-left: 5px solid #ffc107; }

        .btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin: 6px 4px;
            box-shadow: 0 4px 10px rgba(40,167,69,0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, #20c997, #28a745);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            box-shadow: 0 4px 10px rgba(108,117,125,0.3);
        }

        .data-block {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #007bff;
            margin: 10px 0 0 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size:0.9em;
        }

        .data-table th, .data-table td {
            border: 1px solid #dee2e6;
            padding: 6px 8px;
            text-align: center;
        }

        .options-grid {
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(230px,1fr));
            gap:10px;
            margin-top:10px;
        }

        .option-checkbox {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            border-radius: 10px;
            padding: 8px 10px;
            border: 2px solid #ced4da;
            display:flex;
            gap:8px;
            align-items:flex-start;
            font-size:0.85em;
        }

        .question-card {
            background:#f8f9fa;
            border-radius:10px;
            border:2px solid #dee2e6;
            padding:12px;
            margin:10px 0;
            font-size:0.9em;
        }

        .question-card h5 {
            margin-bottom:6px;
            color:#007bff;
            font-size:0.95em;
        }

        .question-input {
            margin-top:6px;
            display:flex;
            flex-wrap:wrap;
            align-items:center;
            gap:6px;
        }

        .question-input input {
            padding:6px 8px;
            border-radius:6px;
            border:1px solid #ced4da;
            min-width:100px;
        }

        .feedback {
            margin-top:4px;
            font-size:0.85em;
        }

        .feedback.correct {
            color:#155724;
        }

        .feedback.incorrect {
            color:#721c24;
        }

        .step-explanation {
            margin-top:6px;
            font-size:0.85em;
            background:white;
            border-radius:6px;
            padding:8px;
            border-left:3px solid #17a2b8;
        }

        .interpretation-box {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding:15px;
            border-radius:10px;
            margin:15px 0;
            border:2px solid #2196f3;
            font-size:0.9em;
        }

        .score-display {
            background: linear-gradient(135deg, #e83e8c, #d91a72);
            color:white;
            padding:15px;
            text-align:center;
            border-radius:12px;
            margin:10px 0 20px 0;
            border:3px solid #c7185d;
            box-shadow:0 4px 15px rgba(232,62,140,0.3);
            font-size:0.9em;
        }

        @media (max-width:768px) {
            .measures-grid { grid-template-columns:1fr; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="red-title">
        <h1>üìä Decomposing Changes over Time (Wooldridge 9.3)</h1>
        <p>Practice splitting changes in mean outcomes into composition (XÃÑ changes) and structure (Œ≤ changes)</p>
    </div>

    <div class="blue-concepts">
        <h3>üìò Key Ideas: Composition vs Structure in Pooled Cross Sections</h3>
        <div class="measures-grid">
            <div class="measure-card decomp-card">
                <h4>Change in Mean Outcome</h4>
                <div class="formula">
                    E‚ÇÄ(Y) = Œ≤‚ÇÄ‚ÇÄ + Œ≤‚ÇÅ‚ÇÄ¬∑XÃÑ‚ÇÄ<br>
                    E‚ÇÅ(Y) = Œ≤‚ÇÄ‚ÇÅ + Œ≤‚ÇÅ‚ÇÅ¬∑XÃÑ‚ÇÅ<br>
                    ŒîE(Y) = E‚ÇÅ(Y) ‚àí E‚ÇÄ(Y)
                </div>
                <div class="description">
                    With pooled cross sections at two time periods, we can compute the predicted mean of Y in each period using the regression and the mean of X in that period.
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> Wage growth, house price changes, changes in smoking rates, etc.
                </div>
                <div class="examples">
                    <strong>Example:</strong> Mean log wage in 1980 vs 2000.
                </div>
            </div>

            <div class="measure-card comp-card">
                <h4>Composition Effect (Change in XÃÑ)</h4>
                <div class="formula">
                    Comp = [Œ≤‚ÇÄ‚ÇÄ + Œ≤‚ÇÅ‚ÇÄ¬∑XÃÑ‚ÇÅ] ‚àí [Œ≤‚ÇÄ‚ÇÄ + Œ≤‚ÇÅ‚ÇÄ¬∑XÃÑ‚ÇÄ]
                </div>
                <div class="description">
                    The composition effect asks: what would the mean of Y be if only XÃÑ changed from XÃÑ‚ÇÄ to XÃÑ‚ÇÅ, while the regression relationship (Œ≤‚Äôs) stayed at their initial values?
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> How much wage growth is due to more education?
                </div>
                <div class="examples">
                    <strong>Example:</strong> Higher average schooling explains part of wage growth.
                </div>
            </div>

            <div class="measure-card struct-card">
                <h4>Structure Effect (Change in Œ≤)</h4>
                <div class="formula">
                    Struct = E‚ÇÅ(Y) ‚àí [Œ≤‚ÇÄ‚ÇÄ + Œ≤‚ÇÅ‚ÇÄ¬∑XÃÑ‚ÇÅ]
                </div>
                <div class="description">
                    The structure effect asks: after accounting for changes in XÃÑ, how much of the remaining change is due to changes in the regression function itself (intercept/slope changes)?
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> Changes in returns to education, risk premiums, policy effects over time.
                </div>
                <div class="examples">
                    <strong>Example:</strong> The return to education might increase even if education levels stay fixed.
                </div>
            </div>

            <div class="measure-card practice-card">
                <h4>Brief Practical Discussion</h4>
                <div class="formula">
                    Total change = composition + structure
                </div>
                <div class="description">
                    This decomposition is a simple version of Oaxaca-style decompositions. It is useful in pooled cross-section settings when you want to separate ‚Äúwho is in the sample‚Äù from ‚Äúhow the relationship between Y and X has changed.‚Äù
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> Wage inequality studies, regional growth, health behavior changes.
                </div>
                <div class="examples">
                    <strong>Rule of thumb:</strong> Always be clear about which period‚Äôs coefficients you use for the counterfactual.
                </div>
            </div>
        </div>
    </div>

    <div class="interactive-section">
        <div class="control-panel">
            <h3>üéÆ Interactive Practice: Decomposing Changes in Mean Outcomes</h3>
            <p>Each scenario provides regressions at two time periods and the mean of X in each period. Compute predicted means, the total change, and a decomposition into composition and structure effects.</p>
            <button class="btn" onclick="generateScenario()">üìä Generate New Scenario</button>
            <button class="btn btn-secondary" onclick="resetPractice()">üîÑ Reset</button>
        </div>

        <div id="scenarioDisplay" class="scenario-display" style="display:none;">
            <h3 id="scenarioTitle">üìã Scenario</h3>
            <div id="scenarioDescription"></div>
            <div id="dataDisplay"></div>

            <div style="margin-top: 12px; padding: 12px; background:#f8f9fa; border-radius:10px; border-left:4px solid #6c757d;">
                <h4>‚öôÔ∏è Choose Tasks to Practice</h4>
                <p style="font-size:0.85em;color:#555;">
                    Use the two regressions and the sample means of X to compute predicted mean outcomes in each period and to split the change into a composition part (change in XÃÑ) and a structure part (change in Œ≤‚Äôs).
                </p>
                <div class="options-grid">
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkBaseline" checked>
                        <div><strong>üèÅ Predicted means E‚ÇÄ(Y), E‚ÇÅ(Y)</strong><br>Compute the predicted mean outcome in each period.</div>
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkOtherMeans" checked>
                        <div><strong>üìä Composition effect</strong><br>Compute the part of the change due to shifts in XÃÑ, holding Œ≤ fixed at period 0 values.</div>
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkDifference" checked>
                        <div><strong>üìâ Structure effect</strong><br>Compute the part of the change due to changes in Œ≤‚Äôs, holding XÃÑ fixed at period 1.</div>
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkInterpret" checked>
                        <div><strong>üß† Interpretation (open answer)</strong><br>Explain what composition vs structure means in the context.</div>
                    </label>
                </div>

                <button class="btn" onclick="generateQuestions()" style="margin-top:10px;">üßÆ Generate Questions</button>
            </div>
        </div>

        <div id="calculationArea" class="calculation-area" style="display:none;">
            <h3>üìù Questions & Feedback</h3>
            <div id="questionsContainer"></div>
            <button class="btn" onclick="checkAnswers()">‚úÖ Check Answers</button>
            <div id="interpretationDisplay"></div>
        </div>

        <div class="score-display">
            <h3>üéØ Practice Progress</h3>
            <div>Scenarios Practiced: <span id="scenariosCompleted">0</span></div>
        </div>
    </div>
</div>

<script>
    console.log("Decomposing changes over time (9.3) practice loaded.");

    var currentScenario = null;
    var scenariosCompleted = 0;
    var currentQuestions = [];

    // Scenarios: two time periods, regressions and XÃÑ in each period
    // We use a single X for clarity (like in Wooldridge‚Äôs simple exposition).
    var scenarios = [
        {
            id: "wageEducationGrowth",
            title: "Wage Growth and Education Composition",
            description: "You have two independent cross sections of workers from 1990 and 2010. In each year, you regress hourly wage on years of education. The education distribution also changes over time.",
            context: "Decompose the change in average wages into a composition effect (more education) and a structure effect (change in returns to education).",
            yName: "Wage",
            xName: "Educ (years of schooling)",
            yUnits: "dollars per hour",
            period0: "1990",
            period1: "2010",
            beta0_0: 5,      // intercept 1990
            beta1_0: 0.8,    // slope 1990
            xbar0: 12,       // mean educ 1990
            beta0_1: 6,      // intercept 2010
            beta1_1: 1.0,    // slope 2010
            xbar1: 14,       // mean educ 2010
            expertInterpretation:
                "Between 1990 and 2010, average wages rose because (i) workers became more educated (composition effect: higher XÃÑ), and (ii) the return to education increased and the intercept shifted (structure effect: changes in Œ≤‚ÇÄ and Œ≤‚ÇÅ). The composition effect isolates the impact of XÃÑ changing, while the structure effect captures changes in the wage‚Äìeducation relationship itself."
        },
        {
            id: "houseSizePrices",
            title: "House Prices and Average Size",
            description: "You observe house sales in 2000 and 2020. You regress price on house size in each year, and you know the mean house size in each year.",
            context: "Split the change in average house prices into the effect of bigger houses vs the effect of higher price per square meter and intercept shifts.",
            yName: "Price",
            xName: "Size (in m¬≤)",
            yUnits: "thousand dollars",
            period0: "2000",
            period1: "2020",
            beta0_0: 80,
            beta1_0: 0.25,
            xbar0: 120,
            beta0_1: 90,
            beta1_1: 0.35,
            xbar1: 140,
            expertInterpretation:
                "Average house prices rose both because houses got larger on average (composition effect) and because the price‚Äìsize schedule shifted up (higher intercept) and became steeper (higher slope). The decomposition shows how much of the change comes from larger average size versus higher prices per square meter."
        },
        {
            id: "smokingIncome",
            title: "Smoking Rates, Income, and Behavioral Shifts",
            description: "You have two cross sections, 2005 and 2015, and you regress smoking rate (in %) on income. Income levels and the slope of the income‚Äìsmoking relationship both change.",
            context: "Decompose the change in smoking rates into changing income composition vs changing behavioral relationship between smoking and income.",
            yName: "SmokeRate",
            xName: "Income (in $1,000s)",
            yUnits: "percentage points",
            period0: "2005",
            period1: "2015",
            beta0_0: 35,
            beta1_0: -0.10,
            xbar0: 30,
            beta0_1: 32,
            beta1_1: -0.20,
            xbar1: 40,
            expertInterpretation:
                "Overall smoking rates fell between 2005 and 2015. Part of this can be attributed to higher incomes on average (composition effect, given a negative slope), and part to a stronger negative relationship between smoking and income plus a lower intercept (structure effect). The decomposition quantifies each component."
        }
    ];

    function generateScenario() {
        var idx = Math.floor(Math.random() * scenarios.length);
        currentScenario = scenarios[idx];
        console.log("Scenario:", currentScenario.id);

        currentQuestions = [];

        document.getElementById("scenarioDisplay").style.display = "block";
        document.getElementById("calculationArea").style.display = "none";
        document.getElementById("interpretationDisplay").innerHTML = "";
        document.getElementById("questionsContainer").innerHTML = "";

        document.getElementById("scenarioTitle").textContent = "üìä " + currentScenario.title;

        var descHtml = "";
        descHtml += '<div class="data-block">';
        descHtml += '<h4>üìã Context:</h4>';
        descHtml += '<p style="margin-top:8px;">' + currentScenario.description + '</p>';
        descHtml += '<p style="margin-top:8px;font-style:italic;color:#6c757d;"><strong>Goal:</strong> ' +
                    currentScenario.context + '</p>';
        descHtml += '</div>';
        document.getElementById("scenarioDescription").innerHTML = descHtml;

        displayData(currentScenario);

        document.getElementById("chkBaseline").checked = true;
        document.getElementById("chkOtherMeans").checked = true;
        document.getElementById("chkDifference").checked = true;
        document.getElementById("chkInterpret").checked = true;
    }

    function displayData(scenario) {
        var html = "";
        html += '<h4>üìã Regressions and Means in Two Periods</h4>';
        html += '<div class="data-block">';
        html += '<p><strong>Outcome:</strong> ' + scenario.yName + ' (' + scenario.yUnits + ')</p>';
        html += '<p><strong>Regressor:</strong> ' + scenario.xName + '</p>';

        html += '<table class="data-table" style="margin-top:12px;">';
        html += '<thead><tr><th>Period</th><th>Regression</th><th>Mean of X (XÃÑ)</th></tr></thead><tbody>';

        html += '<tr><td>' + scenario.period0 + '</td><td>' +
                scenario.yName + ' = ' +
                scenario.beta0_0.toFixed(2) + ' + ' +
                scenario.beta1_0.toFixed(2) + '¬∑' + scenario.xName +
                '</td><td>XÃÑ‚ÇÄ = ' + scenario.xbar0.toFixed(2) + '</td></tr>';

        html += '<tr><td>' + scenario.period1 + '</td><td>' +
                scenario.yName + ' = ' +
                scenario.beta0_1.toFixed(2) + ' + ' +
                scenario.beta1_1.toFixed(2) + '¬∑' + scenario.xName +
                '</td><td>XÃÑ‚ÇÅ = ' + scenario.xbar1.toFixed(2) + '</td></tr>';

        html += '</tbody></table>';

        html += '<p style="margin-top:10px;font-size:0.9em;">';
        html += '<strong>Reminder:</strong> Predicted mean outcomes are E‚ÇÄ(Y) = Œ≤‚ÇÄ‚ÇÄ + Œ≤‚ÇÅ‚ÇÄ¬∑XÃÑ‚ÇÄ and E‚ÇÅ(Y) = Œ≤‚ÇÄ‚ÇÅ + Œ≤‚ÇÅ‚ÇÅ¬∑XÃÑ‚ÇÅ.';
        html += ' A simple decomposition uses the counterfactual mean [Œ≤‚ÇÄ‚ÇÄ + Œ≤‚ÇÅ‚ÇÄ¬∑XÃÑ‚ÇÅ] to isolate the composition effect.';
        html += '</p>';

        html += '</div>';

        document.getElementById("dataDisplay").innerHTML = html;
    }

    function generateQuestions() {
        if (!currentScenario) {
            alert("Please generate a scenario first.");
            return;
        }

        currentQuestions = [];
        var container = document.getElementById("questionsContainer");
        container.innerHTML = "";

        var chkBaseline   = document.getElementById("chkBaseline").checked;
        var chkOtherMeans = document.getElementById("chkOtherMeans").checked;
        var chkDifference = document.getElementById("chkDifference").checked;
        var chkInterpret  = document.getElementById("chkInterpret").checked;

        var s = currentScenario;

        // Predicted means
        var E0 = s.beta0_0 + s.beta1_0 * s.xbar0;    // period 0, using 0 coefficients, XÃÑ0
        var E1 = s.beta0_1 + s.beta1_1 * s.xbar1;    // period 1, using 1 coefficients, XÃÑ1
        var totalChange = E1 - E0;

        // Counterfactual with composition only: use period 0 coefficients with period 1 XÃÑ
        var E_comp = s.beta0_0 + s.beta1_0 * s.xbar1;
        var compositionEffect = E_comp - E0;

        // Structure effect: remainder
        var structureEffect = E1 - E_comp;

        if (chkBaseline) {
            currentQuestions.push({
                conceptId: "E0",
                type: "numeric",
                title: "üèÅ Predicted mean in period 0, E‚ÇÄ(Y)",
                prompt: "Compute E‚ÇÄ(Y) using period 0 regression and XÃÑ‚ÇÄ: E‚ÇÄ(Y) = Œ≤‚ÇÄ‚ÇÄ + Œ≤‚ÇÅ‚ÇÄ¬∑XÃÑ‚ÇÄ.",
                correctValue: E0,
                unitHint: "(" + s.yUnits + ")"
            });
            currentQuestions.push({
                conceptId: "E1",
                type: "numeric",
                title: "üèÅ Predicted mean in period 1, E‚ÇÅ(Y)",
                prompt: "Compute E‚ÇÅ(Y) using period 1 regression and XÃÑ‚ÇÅ: E‚ÇÅ(Y) = Œ≤‚ÇÄ‚ÇÅ + Œ≤‚ÇÅ‚ÇÅ¬∑XÃÑ‚ÇÅ.",
                correctValue: E1,
                unitHint: "(" + s.yUnits + ")"
            });
            currentQuestions.push({
                conceptId: "totalChange",
                type: "numeric",
                title: "üèÅ Total change in predicted mean, ŒîE(Y)",
                prompt: "Compute the total change in the predicted mean outcome: ŒîE(Y) = E‚ÇÅ(Y) ‚àí E‚ÇÄ(Y).",
                correctValue: totalChange,
                unitHint: "(" + s.yUnits + ")"
            });
        }

        if (chkOtherMeans) {
            currentQuestions.push({
                conceptId: "Ecomp",
                type: "numeric",
                title: "üìä Counterfactual mean with composition only",
                prompt: "Compute the counterfactual mean using period 0 coefficients and the period 1 mean of X: E_comp = Œ≤‚ÇÄ‚ÇÄ + Œ≤‚ÇÅ‚ÇÄ¬∑XÃÑ‚ÇÅ.",
                correctValue: E_comp,
                unitHint: "(" + s.yUnits + ")"
            });
            currentQuestions.push({
                conceptId: "compositionEffect",
                type: "numeric",
                title: "üìä Composition effect",
                prompt: "Compute the composition effect: Comp = E_comp ‚àí E‚ÇÄ(Y). This is the part of ŒîE(Y) due purely to XÃÑ changing from XÃÑ‚ÇÄ to XÃÑ‚ÇÅ.",
                correctValue: compositionEffect,
                unitHint: "(" + s.yUnits + ")"
            });
        }

        if (chkDifference) {
            currentQuestions.push({
                conceptId: "structureEffect",
                type: "numeric",
                title: "üìâ Structure effect",
                prompt: "Compute the structure effect: Struct = E‚ÇÅ(Y) ‚àí E_comp. This is the part of ŒîE(Y) due to changes in Œ≤‚Äôs, holding XÃÑ fixed at XÃÑ‚ÇÅ.",
                correctValue: structureEffect,
                unitHint: "(" + s.yUnits + ")"
            });
        }

        if (chkInterpret) {
            currentQuestions.push({
                conceptId: "interpret",
                type: "open",
                title: "üß† Interpretation (Open Answer)",
                prompt: "In words, explain what the composition and structure effects mean in this scenario. Then compare with the expert wording below.",
                correctText: ""
            });
        }

        if (currentQuestions.length === 0) {
            container.innerHTML = "<p>No tasks selected. Tick at least one box.</p>";
            document.getElementById("calculationArea").style.display = "block";
            return;
        }

        var html = "";
        for (var j = 0; j < currentQuestions.length; j++) {
            html += renderQuestionCard(currentQuestions[j], j);
        }
        container.innerHTML = html;

        document.getElementById("calculationArea").style.display = "block";
        document.getElementById("interpretationDisplay").innerHTML = "";
    }

    function renderQuestionCard(q, index) {
        var html = "";
        html += '<div class="question-card">';
        html += '<h5>' + q.title + '</h5>';
        html += '<p>' + q.prompt + '</p>';
        html += '<div class="question-input">';
        html += '<label for="answer_' + index + '"><strong>Your answer:</strong></label>';
        html += '<input type="text" id="answer_' + index + '">';
        if (q.unitHint) {
            html += '<span>' + q.unitHint + '</span>';
        }
        html += '</div>';
        html += '<div id="feedback_' + index + '" class="feedback"></div>';
        html += '<div id="explain_' + index + '" class="step-explanation" style="display:none;"></div>';
        html += '</div>';
        return html;
    }

    function checkAnswers() {
        if (currentQuestions.length === 0) {
            alert("No questions to check. Generate questions first.");
            return;
        }

        var numCorrect = 0;

        for (var i = 0; i < currentQuestions.length; i++) {
            var q = currentQuestions[i];
            var ansInput = document.getElementById("answer_" + i);
            var feedbackEl = document.getElementById("feedback_" + i);
            var explainEl = document.getElementById("explain_" + i);

            if (!ansInput) continue;

            var userRaw = ansInput.value.trim();
            if (userRaw === "") {
                feedbackEl.textContent = "Please enter an answer.";
                feedbackEl.className = "feedback";
                explainEl.style.display = "none";
                continue;
            }

            if (q.type === "numeric") {
                var userVal = parseFloat(userRaw);
                if (isNaN(userVal)) {
                    feedbackEl.textContent = "Please enter a numeric answer.";
                    feedbackEl.className = "feedback";
                    explainEl.style.display = "none";
                    continue;
                }
                var correct = q.correctValue;
                var ok = isCloseNumeric(userVal, correct);
                if (ok) {
                    numCorrect++;
                    feedbackEl.textContent = "‚úÖ Correct (expected about " + correct.toFixed(2) + ").";
                    feedbackEl.className = "feedback correct";
                } else {
                    feedbackEl.textContent = "‚ùå Not quite. A good answer is about " + correct.toFixed(2) + ".";
                    feedbackEl.className = "feedback incorrect";
                }
            } else if (q.type === "open") {
                feedbackEl.textContent = "üìù Thanks for your explanation. Compare it with the expert interpretation below.";
                feedbackEl.className = "feedback";
            }

            explainEl.innerHTML = getExplanationHtml(q);
            explainEl.style.display = "block";
        }

        var interpLines = [];
        interpLines.push("‚Ä¢ You answered " + numCorrect + " out of " + currentQuestions.length + " auto-graded questions correctly (within tolerance).");
        interpLines.push("‚Ä¢ Remember: total change in mean outcomes can be split into a composition effect (changing XÃÑ) and a structure effect (changing Œ≤‚Äôs).");
        document.getElementById("interpretationDisplay").innerHTML =
            '<div class="interpretation-box"><h4>üß† Summary of This Practice Round</h4>' +
            interpLines.join("<br>") + '</div>';

        scenariosCompleted++;
        document.getElementById("scenariosCompleted").textContent = String(scenariosCompleted);
    }

    function isCloseNumeric(userVal, correctVal) {
        var diff = Math.abs(userVal - correctVal);
        var tol = Math.max(0.1, Math.abs(correctVal) * 0.03); // ¬±3% or at least 0.1
        return diff <= tol;
    }

    function getExplanationHtml(q) {
        if (!currentScenario) return "";

        var s = currentScenario;
        var html = "<strong>How to think about this:</strong><br>";

        var E0 = s.beta0_0 + s.beta1_0 * s.xbar0;
        var E1 = s.beta0_1 + s.beta1_1 * s.xbar1;
        var totalChange = E1 - E0;
        var E_comp = s.beta0_0 + s.beta1_0 * s.xbar1;
        var compositionEffect = E_comp - E0;
        var structureEffect = E1 - E_comp;

        if (q.conceptId === "E0") {
            html += "Use the period 0 regression and mean XÃÑ‚ÇÄ:<br>";
            html += "E‚ÇÄ(Y) = Œ≤‚ÇÄ‚ÇÄ + Œ≤‚ÇÅ‚ÇÄ¬∑XÃÑ‚ÇÄ = " +
                    s.beta0_0.toFixed(2) + " + " +
                    s.beta1_0.toFixed(2) + "¬∑(" + s.xbar0.toFixed(2) + ") = " +
                    E0.toFixed(2) + " " + s.yUnits + ".";
        } else if (q.conceptId === "E1") {
            html += "Use the period 1 regression and mean XÃÑ‚ÇÅ:<br>";
            html += "E‚ÇÅ(Y) = Œ≤‚ÇÄ‚ÇÅ + Œ≤‚ÇÅ‚ÇÅ¬∑XÃÑ‚ÇÅ = " +
                    s.beta0_1.toFixed(2) + " + " +
                    s.beta1_1.toFixed(2) + "¬∑(" + s.xbar1.toFixed(2) + ") = " +
                    E1.toFixed(2) + " " + s.yUnits + ".";
        } else if (q.conceptId === "totalChange") {
            html += "Total change in predicted mean: ŒîE(Y) = E‚ÇÅ(Y) ‚àí E‚ÇÄ(Y).<br>";
            html += "Here ŒîE(Y) = " + E1.toFixed(2) + " ‚àí " + E0.toFixed(2) +
                    " = " + totalChange.toFixed(2) + " " + s.yUnits + ".";
        } else if (q.conceptId === "Ecomp") {
            html += "For the composition counterfactual, keep Œ≤‚Äôs at period 0 values but plug in XÃÑ‚ÇÅ:<br>";
            html += "E_comp = Œ≤‚ÇÄ‚ÇÄ + Œ≤‚ÇÅ‚ÇÄ¬∑XÃÑ‚ÇÅ = " +
                    s.beta0_0.toFixed(2) + " + " +
                    s.beta1_0.toFixed(2) + "¬∑(" + s.xbar1.toFixed(2) + ") = " +
                    E_comp.toFixed(2) + " " + s.yUnits + ".";
        } else if (q.conceptId === "compositionEffect") {
            html += "Composition effect: Comp = E_comp ‚àí E‚ÇÄ(Y).<br>";
            html += "Comp = " + E_comp.toFixed(2) + " ‚àí " + E0.toFixed(2) +
                    " = " + compositionEffect.toFixed(2) + " " + s.yUnits + ".";
            html += " This is the part of the change due solely to XÃÑ moving from XÃÑ‚ÇÄ to XÃÑ‚ÇÅ while holding Œ≤‚Äôs fixed at period 0 values.";
        } else if (q.conceptId === "structureEffect") {
            html += "Structure effect: Struct = E‚ÇÅ(Y) ‚àí E_comp.<br>";
            html += "Struct = " + E1.toFixed(2) + " ‚àí " + E_comp.toFixed(2) +
                    " = " + structureEffect.toFixed(2) + " " + s.yUnits + ".";
            html += " This is the remaining part of ŒîE(Y) due to changes in the Œ≤‚Äôs (intercept and slope), evaluated at XÃÑ‚ÇÅ.";
        } else if (q.conceptId === "interpret") {
            html += "<em>" + s.expertInterpretation + "</em>";
        } else {
            html += "The key idea: ŒîE(Y) = (composition effect) + (structure effect). We build a counterfactual mean using one period‚Äôs Œ≤‚Äôs and the other period‚Äôs XÃÑ to isolate each piece.";
        }

        return html;
    }

    function resetPractice() {
        currentScenario = null;
        currentQuestions = [];
        scenariosCompleted = 0;
        document.getElementById("scenariosCompleted").textContent = "0";
        document.getElementById("scenarioDisplay").style.display = "none";
        document.getElementById("calculationArea").style.display = "none";
        document.getElementById("questionsContainer").innerHTML = "";
        document.getElementById("interpretationDisplay").innerHTML = "";
        document.getElementById("dataDisplay").innerHTML = "";
        document.getElementById("scenarioDescription").innerHTML = "";
        console.log("Decomposition practice reset.");
    }

    document.getElementById("scenariosCompleted").textContent = "0";
</script>
</body>
</html>
