<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Policy Analysis with Pooled Cross Sections (Wooldridge 9.2)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .red-title {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 5px solid #a71e2a;
        }

        .red-title h1 {
            font-size: 2.3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .red-title p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .blue-concepts {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 25px;
        }

        .blue-concepts h3 {
            font-size: 1.7em;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .measures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }

        .measure-card {
            padding: 18px;
            border-radius: 15px;
            border: 3px solid;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .did-card      { background: linear-gradient(135deg, #28a745, #20c997); border-color:#1e7e34; color:white; }
        .setup-card    { background: linear-gradient(135deg, #6f42c1, #8e44ad); border-color:#563d7c; color:white; }
        .effect-card   { background: linear-gradient(135deg, #17a2b8, #138496); border-color:#117a8b; color:white; }
        .practice-card { background: linear-gradient(135deg, #ffc107, #ff8800); border-color:#d39e00; color:#212529; }

        .measure-card h4 {
            font-size: 1.2em;
            margin-bottom: 10px;
            text-align: center;
        }

        .measure-card .formula {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 8px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-align: center;
            font-size: 0.85em;
        }

        .measure-card .description { margin-bottom: 10px; font-size:0.9em; }
        .measure-card .use-cases   { margin-bottom: 10px; font-style: italic; font-size:0.85em; }
        .measure-card .examples    { font-size:0.8em; border-top: 2px solid rgba(255,255,255,0.3); padding-top: 8px; }

        .interactive-section {
            padding: 25px;
            background: #f8f9fa;
        }

        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #007bff;
        }

        .scenario-display,
        .calculation-area {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .scenario-display { border-left: 5px solid #28a745; }
        .calculation-area { border-left: 5px solid #ffc107; }

        .btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin: 6px 4px;
            box-shadow: 0 4px 10px rgba(40,167,69,0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, #20c997, #28a745);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            box-shadow: 0 4px 10px rgba(108,117,125,0.3);
        }

        .data-block {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #007bff;
            margin: 10px 0 0 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size:0.9em;
        }

        .data-table th, .data-table td {
            border: 1px solid #dee2e6;
            padding: 6px 8px;
            text-align: center;
        }

        .options-grid {
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(230px,1fr));
            gap:10px;
            margin-top:10px;
        }

        .option-checkbox {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            border-radius: 10px;
            padding: 8px 10px;
            border: 2px solid #ced4da;
            display:flex;
            gap:8px;
            align-items:flex-start;
            font-size:0.85em;
        }

        .question-card {
            background:#f8f9fa;
            border-radius:10px;
            border:2px solid #dee2e6;
            padding:12px;
            margin:10px 0;
            font-size:0.9em;
        }

        .question-card h5 {
            margin-bottom:6px;
            color:#007bff;
            font-size:0.95em;
        }

        .question-input {
            margin-top:6px;
            display:flex;
            flex-wrap:wrap;
            align-items:center;
            gap:6px;
        }

        .question-input input {
            padding:6px 8px;
            border-radius:6px;
            border:1px solid #ced4da;
            min-width:100px;
        }

        .feedback {
            margin-top:4px;
            font-size:0.85em;
        }

        .feedback.correct {
            color:#155724;
        }

        .feedback.incorrect {
            color:#721c24;
        }

        .step-explanation {
            margin-top:6px;
            font-size:0.85em;
            background:white;
            border-radius:6px;
            padding:8px;
            border-left:3px solid #17a2b8;
        }

        .interpretation-box {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding:15px;
            border-radius:10px;
            margin:15px 0;
            border:2px solid #2196f3;
            font-size:0.9em;
        }

        .score-display {
            background: linear-gradient(135deg, #e83e8c, #d91a72);
            color:white;
            padding:15px;
            text-align:center;
            border-radius:12px;
            margin:10px 0 20px 0;
            border:3px solid #c7185d;
            box-shadow:0 4px 15px rgba(232,62,140,0.3);
            font-size:0.9em;
        }

        @media (max-width:768px) {
            .measures-grid { grid-template-columns:1fr; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="red-title">
        <h1>üìä Policy Analysis with Pooled Cross Sections (Wooldridge 9.2)</h1>
        <p>Practice computing and interpreting difference-in-differences using treatment, time, and interaction dummies</p>
    </div>

    <div class="blue-concepts">
        <h3>üìò Key Ideas: Difference-in-Differences (DiD) with Pooled Cross Sections</h3>
        <div class="measures-grid">
            <div class="measure-card did-card">
                <h4>Basic DiD Setup</h4>
                <div class="formula">
                    Y = Œ≤‚ÇÄ + Œ≤‚ÇÅ¬∑Treat + Œ≤‚ÇÇ¬∑Post + Œ¥¬∑(Treat¬∑Post) + u
                </div>
                <div class="description">
                    We have a <strong>treatment group</strong> (Treat=1) and a <strong>control group</strong> (Treat=0), observed in a <strong>pre</strong> period (Post=0) and a <strong>post</strong> period (Post=1). The interaction Treat¬∑Post captures the DiD effect.
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> Policy changes affecting only some regions, states, or firms.
                </div>
                <div class="examples">
                    <strong>Example:</strong> Minimum wage increase in one state vs neighboring state with no change.
                </div>
            </div>

            <div class="measure-card setup-card">
                <h4>Four Group-Time Cells</h4>
                <div class="formula">
                    Control, pre: Treat=0, Post=0<br>
                    Control, post: Treat=0, Post=1<br>
                    Treat, pre: Treat=1, Post=0<br>
                    Treat, post: Treat=1, Post=1
                </div>
                <div class="description">
                    Each combination of group (treatment/control) and time (pre/post) has its own expected value of Y, obtained by plugging into the regression equation.
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> Compute cell means and differences explicitly.
                </div>
                <div class="examples">
                    <strong>Example:</strong> Compare how Y changes over time in treatment vs control.
                </div>
            </div>

            <div class="measure-card effect-card">
                <h4>The DiD Effect Œ¥</h4>
                <div class="formula">
                    Œ¥ = [ŒîY<sub>treat</sub>] ‚àí [ŒîY<sub>control</sub>]
                </div>
                <div class="description">
                    Œ¥ is the difference-in-differences: the change over time in the treatment group minus the change over time in the control group. In the regression, Œ¥ is exactly the coefficient on the interaction Treat¬∑Post.
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> Policy effects when common-trends assumption is plausible.
                </div>
                <div class="examples">
                    <strong>Example:</strong> Œ¥ = ‚àí2 means the policy reduced Y by 2 units relative to the control trend.
                </div>
            </div>

            <div class="measure-card practice-card">
                <h4>Brief Practical Discussion</h4>
                <div class="formula">
                    Pooled CS + DiD = simple policy evaluation
                </div>
                <div class="description">
                    With repeated cross sections (not a panel), DiD still works as long as treatment and control groups would have followed similar trends in the absence of the policy. The regression with an interaction dummy implements DiD in one step.
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> Minimum wage laws, training subsidies, tax changes, smoking bans, etc.
                </div>
                <div class="examples">
                    <strong>Rule of thumb:</strong> Always check what Œ¥ means in terms of changes over time in each group.
                </div>
            </div>
        </div>
    </div>

    <div class="interactive-section">
        <div class="control-panel">
            <h3>üéÆ Interactive Practice: Computing Difference-in-Differences</h3>
            <p>Each scenario gives you a DiD-style pooled cross-sectional regression. Compute expected outcomes in each group‚Äìtime cell, the change over time in each group, and the DiD effect Œ¥.</p>
            <button class="btn" onclick="generateScenario()">üìä Generate New Scenario</button>
            <button class="btn btn-secondary" onclick="resetPractice()">üîÑ Reset</button>
        </div>

        <div id="scenarioDisplay" class="scenario-display" style="display:none;">
            <h3 id="scenarioTitle">üìã Scenario</h3>
            <div id="scenarioDescription"></div>
            <div id="dataDisplay"></div>

            <div style="margin-top: 12px; padding: 12px; background:#f8f9fa; border-radius:10px; border-left:4px solid #6c757d;">
                <h4>‚öôÔ∏è Choose Tasks to Practice</h4>
                <p style="font-size:0.85em;color:#555;">
                    Use the regression equation to compute the four cell means, the change over time in each group, and the DiD effect Œ¥ (treatment change minus control change).
                </p>
                <div class="options-grid">
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkBaseline" checked>
                        <div><strong>üèÅ Cell means</strong><br>Compute E[Y] in each group‚Äìtime cell (control/treat √ó pre/post).</div>
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkOtherMeans" checked>
                        <div><strong>üìä Group-specific changes</strong><br>Compute ŒîY for treatment and control groups over time.</div>
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkDifference" checked>
                        <div><strong>üìâ DiD effect</strong><br>Compute the difference-in-differences and compare to Œ¥.</div>
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkInterpret" checked>
                        <div><strong>üß† Interpretation (open answer)</strong><br>Explain what Œ¥ means in the context of the policy.</div>
                    </label>
                </div>

                <button class="btn" onclick="generateQuestions()" style="margin-top:10px;">üßÆ Generate Questions</button>
            </div>
        </div>

        <div id="calculationArea" class="calculation-area" style="display:none;">
            <h3>üìù Questions & Feedback</h3>
            <div id="questionsContainer"></div>
            <button class="btn" onclick="checkAnswers()">‚úÖ Check Answers</button>
            <div id="interpretationDisplay"></div>
        </div>

        <div class="score-display">
            <h3>üéØ Practice Progress</h3>
            <div>Scenarios Practiced: <span id="scenariosCompleted">0</span></div>
        </div>
    </div>
</div>

<script>
    console.log("Policy analysis with pooled cross sections (9.2) practice loaded.");

    var currentScenario = null;
    var scenariosCompleted = 0;
    var currentQuestions = [];

    // DiD scenarios: Y = Œ≤0 + Œ≤1*Treat + Œ≤2*Post + Œ¥*(Treat*Post) + u
    var scenarios = [
        {
            id: "minWageTeenEmp",
            title: "Minimum Wage Increase and Teen Employment",
            description: "You compare teen employment rates in State A (which raises the minimum wage) and State B (which does not) using repeated cross sections before and after the policy.",
            context: "Interpret the interaction coefficient as the effect of the minimum wage change on teen employment, relative to State B.",
            model: "Teen employment rate (Y, in percentage points) as a function of Treat, Post, and Treat¬∑Post.",
            treatName: "State A (Treat = 1, raises minimum wage)",
            controlName: "State B (Treat = 0, no change)",
            preLabel: "Before policy (Post = 0)",
            postLabel: "After policy (Post = 1)",
            equation: "EmpRate = 45 ‚àí 3¬∑Treat ‚àí 2¬∑Post ‚àí 4¬∑(Treat¬∑Post)",
            beta0: 45,
            betaTreat: -3,
            betaPost: -2,
            betaInt: -4,
            yUnits: "percentage points",
            expertInterpretation:
                "Baseline (control, pre): 45. Control, post: 43. Treatment, pre: 42. Treatment, post: 36. The control group‚Äôs employment rate falls by 2 points; the treatment group‚Äôs rate falls by 6 points. The DiD effect is ‚àí6 ‚àí (‚àí2) = ‚àí4, equal to the interaction coefficient. This suggests the minimum wage increase reduced teen employment by 4 percentage points relative to the control trend."
        },
        {
            id: "smokingBan",
            title: "Public Smoking Ban and Restaurant Revenues",
            description: "You compare restaurant revenues in a city that adopts a public smoking ban and a neighboring city that does not, using cross sections before and after the ban.",
            context: "Use the DiD setup to measure the effect of the smoking ban on revenues.",
            model: "Monthly restaurant revenue (Y, in $1,000s) as a function of Treat, Post, and Treat¬∑Post.",
            treatName: "Ban city (Treat = 1, smoking ban)",
            controlName: "No-ban city (Treat = 0)",
            preLabel: "Pre-ban (Post = 0)",
            postLabel: "Post-ban (Post = 1)",
            equation: "Revenue = 200 + 10¬∑Treat + 15¬∑Post ‚àí 8¬∑(Treat¬∑Post)",
            beta0: 200,
            betaTreat: 10,
            betaPost: 15,
            betaInt: -8,
            yUnits: "thousand dollars",
            expertInterpretation:
                "Control, pre: 200. Control, post: 215. Treatment, pre: 210. Treatment, post: 217. The control group‚Äôs revenue increases by 15; the treatment group‚Äôs revenue increases by only 7. The DiD effect is 7 ‚àí 15 = ‚àí8, equal to the interaction coefficient. This suggests the smoking ban reduced restaurant revenues by 8 thousand dollars per month relative to the control trend."
        },
        {
            id: "trainingSubsidy",
            title: "Training Subsidy and Average Earnings",
            description: "A training subsidy is introduced in Region T but not in Region C. You pool earnings data from before and after the subsidy for both regions.",
            context: "Interpret the interaction coefficient as the effect of the subsidy on earnings, relative to Region C.",
            model: "Annual earnings (Y, in $1,000s) as a function of Treat, Post, and Treat¬∑Post.",
            treatName: "Region T (Treat = 1, subsidy)",
            controlName: "Region C (Treat = 0, no subsidy)",
            preLabel: "Pre-subsidy (Post = 0)",
            postLabel: "Post-subsidy (Post = 1)",
            equation: "Earnings = 25 ‚àí 2¬∑Treat + 3¬∑Post + 6¬∑(Treat¬∑Post)",
            beta0: 25,
            betaTreat: -2,
            betaPost: 3,
            betaInt: 6,
            yUnits: "thousand dollars",
            expertInterpretation:
                "Control, pre: 25. Control, post: 28. Treatment, pre: 23. Treatment, post: 32. The control group‚Äôs earnings rise by 3; the treatment group‚Äôs earnings rise by 9. The DiD effect is 9 ‚àí 3 = 6, equal to the interaction coefficient. This suggests the training subsidy increased earnings by 6 thousand dollars per year relative to the control trend."
        }
    ];

    function generateScenario() {
        var idx = Math.floor(Math.random() * scenarios.length);
        currentScenario = scenarios[idx];
        console.log("Scenario:", currentScenario.id);

        currentQuestions = [];

        document.getElementById("scenarioDisplay").style.display = "block";
        document.getElementById("calculationArea").style.display = "none";
        document.getElementById("interpretationDisplay").innerHTML = "";
        document.getElementById("questionsContainer").innerHTML = "";

        document.getElementById("scenarioTitle").textContent = "üìä " + currentScenario.title;

        var descHtml = "";
        descHtml += '<div class="data-block">';
        descHtml += '<h4>üìã Context:</h4>';
        descHtml += '<p style="margin-top:8px;">' + currentScenario.description + '</p>';
        descHtml += '<p style="margin-top:8px;font-style:italic;color:#6c757d;"><strong>Goal:</strong> ' +
                    currentScenario.context + '</p>';
        descHtml += '</div>';
        document.getElementById("scenarioDescription").innerHTML = descHtml;

        displayData(currentScenario);

        document.getElementById("chkBaseline").checked = true;
        document.getElementById("chkOtherMeans").checked = true;
        document.getElementById("chkDifference").checked = true;
        document.getElementById("chkInterpret").checked = true;
    }

    function displayData(scenario) {
        var html = "";
        html += '<h4>üìã DiD Regression for Policy Analysis</h4>';
        html += '<div class="data-block">';
        html += '<p><strong>Model:</strong></p>';
        html += '<p style="margin-top:8px; font-family:Courier New, monospace; font-size:1.0em;">';
        html += scenario.equation;
        html += '</p>';

        html += '<p style="margin-top:10px;font-size:0.9em;"><strong>Treatment group:</strong> ' + scenario.treatName + '<br>';
        html += '<strong>Control group:</strong> ' + scenario.controlName + '<br>';
        html += '<strong>Pre period:</strong> ' + scenario.preLabel + '<br>';
        html += '<strong>Post period:</strong> ' + scenario.postLabel + '</p>';

        html += '<table class="data-table" style="margin-top:12px;">';
        html += '<thead><tr><th>Term</th><th>Coefficient</th><th>Interpretation</th></tr></thead><tbody>';
        html += '<tr><td>Intercept (Œ≤‚ÇÄ)</td><td>' + scenario.beta0.toFixed(2) + '</td><td>Control group, pre period mean (Treat=0, Post=0)</td></tr>';
        html += '<tr><td>Treat (Œ≤‚ÇÅ)</td><td>' + scenario.betaTreat.toFixed(2) + '</td><td>Difference between treatment and control in pre period</td></tr>';
        html += '<tr><td>Post (Œ≤‚ÇÇ)</td><td>' + scenario.betaPost.toFixed(2) + '</td><td>Change over time in control group</td></tr>';
        html += '<tr><td>Treat¬∑Post (Œ¥)</td><td>' + scenario.betaInt.toFixed(2) + '</td><td>DiD effect: extra change in treatment group beyond control</td></tr>';
        html += '</tbody></table>';

        html += '<p style="margin-top:10px;font-size:0.9em;">';
        html += '<strong>Reminder:</strong> E[Y|Treat,Post] is obtained by plugging Treat and Post into the regression. The DiD effect is Œ¥, but you can also compute it as (change in treatment) minus (change in control).';
        html += '</p>';

        html += '</div>';

        document.getElementById("dataDisplay").innerHTML = html;
    }

    function generateQuestions() {
        if (!currentScenario) {
            alert("Please generate a scenario first.");
            return;
        }

        currentQuestions = [];
        var container = document.getElementById("questionsContainer");
        container.innerHTML = "";

        var chkBaseline   = document.getElementById("chkBaseline").checked;
        var chkOtherMeans = document.getElementById("chkOtherMeans").checked;
        var chkDifference = document.getElementById("chkDifference").checked;
        var chkInterpret  = document.getElementById("chkInterpret").checked;

        var s = currentScenario;

        // Cell means:
        // Control, pre:   Treat=0, Post=0  => Œ≤0
        // Control, post:  Treat=0, Post=1  => Œ≤0 + Œ≤2
        // Treat, pre:     Treat=1, Post=0  => Œ≤0 + Œ≤1
        // Treat, post:    Treat=1, Post=1  => Œ≤0 + Œ≤1 + Œ≤2 + Œ¥
        var y_C_pre  = s.beta0;
        var y_C_post = s.beta0 + s.betaPost;
        var y_T_pre  = s.beta0 + s.betaTreat;
        var y_T_post = s.beta0 + s.betaTreat + s.betaPost + s.betaInt;

        // Changes over time:
        var d_C = y_C_post - y_C_pre; // should be Œ≤2
        var d_T = y_T_post - y_T_pre; // should be Œ≤2 + Œ¥

        // DiD effect:
        var did = d_T - d_C;          // should be Œ¥

        if (chkBaseline) {
            currentQuestions.push({
                conceptId: "controlPre",
                type: "numeric",
                title: "üèÅ Control group, pre period mean",
                prompt: "What is the predicted mean of Y for the control group in the pre period (Treat=0, Post=0)?",
                correctValue: y_C_pre,
                unitHint: "(" + s.yUnits + ")"
            });
            currentQuestions.push({
                conceptId: "controlPost",
                type: "numeric",
                title: "üèÅ Control group, post period mean",
                prompt: "What is the predicted mean of Y for the control group in the post period (Treat=0, Post=1)?",
                correctValue: y_C_post,
                unitHint: "(" + s.yUnits + ")"
            });
            currentQuestions.push({
                conceptId: "treatPre",
                type: "numeric",
                title: "üèÅ Treatment group, pre period mean",
                prompt: "What is the predicted mean of Y for the treatment group in the pre period (Treat=1, Post=0)?",
                correctValue: y_T_pre,
                unitHint: "(" + s.yUnits + ")"
            });
            currentQuestions.push({
                conceptId: "treatPost",
                type: "numeric",
                title: "üèÅ Treatment group, post period mean",
                prompt: "What is the predicted mean of Y for the treatment group in the post period (Treat=1, Post=1)?",
                correctValue: y_T_post,
                unitHint: "(" + s.yUnits + ")"
            });
        }

        if (chkOtherMeans) {
            currentQuestions.push({
                conceptId: "changeControl",
                type: "numeric",
                title: "üìä Change over time in control group",
                prompt: "Compute the change over time in the control group: ŒîY_control = (control, post) ‚àí (control, pre).",
                correctValue: d_C,
                unitHint: "(" + s.yUnits + ")"
            });
            currentQuestions.push({
                conceptId: "changeTreat",
                type: "numeric",
                title: "üìä Change over time in treatment group",
                prompt: "Compute the change over time in the treatment group: ŒîY_treat = (treat, post) ‚àí (treat, pre).",
                correctValue: d_T,
                unitHint: "(" + s.yUnits + ")"
            });
        }

        if (chkDifference) {
            currentQuestions.push({
                conceptId: "didEffect",
                type: "numeric",
                title: "üìâ Difference-in-differences effect",
                prompt: "Compute the DiD effect: ŒîY_treat ‚àí ŒîY_control. How does it compare to the interaction coefficient Œ¥?",
                correctValue: did,
                unitHint: "(" + s.yUnits + ")"
            });
        }

        if (chkInterpret) {
            currentQuestions.push({
                conceptId: "interpret",
                type: "open",
                title: "üß† Interpretation (Open Answer)",
                prompt: "In words, interpret the interaction coefficient Œ¥ in this scenario. Then compare with the expert wording below.",
                correctText: ""
            });
        }

        if (currentQuestions.length === 0) {
            container.innerHTML = "<p>No tasks selected. Tick at least one box.</p>";
            document.getElementById("calculationArea").style.display = "block";
            return;
        }

        var html = "";
        for (var j = 0; j < currentQuestions.length; j++) {
            html += renderQuestionCard(currentQuestions[j], j);
        }
        container.innerHTML = html;

        document.getElementById("calculationArea").style.display = "block";
        document.getElementById("interpretationDisplay").innerHTML = "";
    }

    function renderQuestionCard(q, index) {
        var html = "";
        html += '<div class="question-card">';
        html += '<h5>' + q.title + '</h5>';
        html += '<p>' + q.prompt + '</p>';
        html += '<div class="question-input">';
        html += '<label for="answer_' + index + '"><strong>Your answer:</strong></label>';
        html += '<input type="text" id="answer_' + index + '">';
        if (q.unitHint) {
            html += '<span>' + q.unitHint + '</span>';
        }
        html += '</div>';
        html += '<div id="feedback_' + index + '" class="feedback"></div>';
        html += '<div id="explain_' + index + '" class="step-explanation" style="display:none;"></div>';
        html += '</div>';
        return html;
    }

    function checkAnswers() {
        if (currentQuestions.length === 0) {
            alert("No questions to check. Generate questions first.");
            return;
        }

        var numCorrect = 0;

        for (var i = 0; i < currentQuestions.length; i++) {
            var q = currentQuestions[i];
            var ansInput = document.getElementById("answer_" + i);
            var feedbackEl = document.getElementById("feedback_" + i);
            var explainEl = document.getElementById("explain_" + i);

            if (!ansInput) continue;

            var userRaw = ansInput.value.trim();
            if (userRaw === "") {
                feedbackEl.textContent = "Please enter an answer.";
                feedbackEl.className = "feedback";
                explainEl.style.display = "none";
                continue;
            }

            if (q.type === "numeric") {
                var userVal = parseFloat(userRaw);
                if (isNaN(userVal)) {
                    feedbackEl.textContent = "Please enter a numeric answer.";
                    feedbackEl.className = "feedback";
                    explainEl.style.display = "none";
                    continue;
                }
                var correct = q.correctValue;
                var ok = isCloseNumeric(userVal, correct);
                if (ok) {
                    numCorrect++;
                    feedbackEl.textContent = "‚úÖ Correct (expected about " + correct.toFixed(2) + ").";
                    feedbackEl.className = "feedback correct";
                } else {
                    feedbackEl.textContent = "‚ùå Not quite. A good answer is about " + correct.toFixed(2) + ".";
                    feedbackEl.className = "feedback incorrect";
                }
            } else if (q.type === "open") {
                feedbackEl.textContent = "üìù Thanks for your explanation. Compare it with the expert interpretation below.";
                feedbackEl.className = "feedback";
            }

            explainEl.innerHTML = getExplanationHtml(q);
            explainEl.style.display = "block";
        }

        var interpLines = [];
        interpLines.push("‚Ä¢ You answered " + numCorrect + " out of " + currentQuestions.length + " auto-graded questions correctly (within tolerance).");
        interpLines.push("‚Ä¢ Remember: The DiD effect is the extra change in the treatment group beyond the control group‚Äôs change, and it equals the coefficient on the interaction term Treat¬∑Post.");
        document.getElementById("interpretationDisplay").innerHTML =
            '<div class="interpretation-box"><h4>üß† Summary of This Practice Round</h4>' +
            interpLines.join("<br>") + '</div>';

        scenariosCompleted++;
        document.getElementById("scenariosCompleted").textContent = String(scenariosCompleted);
    }

    function isCloseNumeric(userVal, correctVal) {
        var diff = Math.abs(userVal - correctVal);
        var tol = Math.max(0.1, Math.abs(correctVal) * 0.03); // ¬±3% or at least 0.1
        return diff <= tol;
    }

    function getExplanationHtml(q) {
        if (!currentScenario) return "";

        var s = currentScenario;
        var html = "<strong>How to think about this:</strong><br>";

        var y_C_pre  = s.beta0;
        var y_C_post = s.beta0 + s.betaPost;
        var y_T_pre  = s.beta0 + s.betaTreat;
        var y_T_post = s.beta0 + s.betaTreat + s.betaPost + s.betaInt;

        var d_C = y_C_post - y_C_pre;
        var d_T = y_T_post - y_T_pre;
        var did = d_T - d_C;

        if (q.conceptId === "controlPre") {
            html += "Set Treat=0 and Post=0 (control, pre):<br>";
            html += "E[Y|control,pre] = Œ≤‚ÇÄ = " + y_C_pre.toFixed(2) + " " + s.yUnits + ".";
        } else if (q.conceptId === "controlPost") {
            html += "Set Treat=0 and Post=1 (control, post):<br>";
            html += "E[Y|control,post] = Œ≤‚ÇÄ + Œ≤‚ÇÇ = " +
                    y_C_post.toFixed(2) + " " + s.yUnits + ".";
        } else if (q.conceptId === "treatPre") {
            html += "Set Treat=1 and Post=0 (treatment, pre):<br>";
            html += "E[Y|treat,pre] = Œ≤‚ÇÄ + Œ≤‚ÇÅ = " +
                    y_T_pre.toFixed(2) + " " + s.yUnits + ".";
        } else if (q.conceptId === "treatPost") {
            html += "Set Treat=1 and Post=1 (treatment, post):<br>";
            html += "E[Y|treat,post] = Œ≤‚ÇÄ + Œ≤‚ÇÅ + Œ≤‚ÇÇ + Œ¥ = " +
                    y_T_post.toFixed(2) + " " + s.yUnits + ".";
        } else if (q.conceptId === "changeControl") {
            html += "Control group change: ŒîY_control = (control, post) ‚àí (control, pre).<br>";
            html += "So ŒîY_control = " + y_C_post.toFixed(2) + " ‚àí " + y_C_pre.toFixed(2) +
                    " = " + d_C.toFixed(2) + " " + s.yUnits + ", which should equal Œ≤‚ÇÇ.";
        } else if (q.conceptId === "changeTreat") {
            html += "Treatment group change: ŒîY_treat = (treat, post) ‚àí (treat, pre).<br>";
            html += "So ŒîY_treat = " + y_T_post.toFixed(2) + " ‚àí " + y_T_pre.toFixed(2) +
                    " = " + d_T.toFixed(2) + " " + s.yUnits + ", which equals Œ≤‚ÇÇ + Œ¥.";
        } else if (q.conceptId === "didEffect") {
            html += "The DiD effect is ŒîY_treat ‚àí ŒîY_control.<br>";
            html += "Here that is " + d_T.toFixed(2) + " ‚àí " + d_C.toFixed(2) +
                    " = " + did.toFixed(2) + " " + s.yUnits + ".<br>";
            html += "Algebraically, this always equals Œ¥, the coefficient on Treat¬∑Post.";
        } else if (q.conceptId === "interpret") {
            html += "<em>" + s.expertInterpretation + "</em>";
        } else {
            html += "DiD compares changes over time in treatment and control groups. The interaction coefficient is the extra change in the treatment group beyond the control group.";
        }

        return html;
    }

    function resetPractice() {
        currentScenario = null;
        currentQuestions = [];
        scenariosCompleted = 0;
        document.getElementById("scenariosCompleted").textContent = "0";
        document.getElementById("scenarioDisplay").style.display = "none";
        document.getElementById("calculationArea").style.display = "none";
        document.getElementById("questionsContainer").innerHTML = "";
        document.getElementById("interpretationDisplay").innerHTML = "";
        document.getElementById("dataDisplay").innerHTML = "";
        document.getElementById("scenarioDescription").innerHTML = "";
        console.log("Policy analysis DiD practice reset.");
    }

    document.getElementById("scenariosCompleted").textContent = "0";
</script>
</body>
</html>
