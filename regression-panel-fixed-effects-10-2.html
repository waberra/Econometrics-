<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fixed Effects Estimation (Wooldridge 10.2)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .red-title {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 5px solid #a71e2a;
        }

        .red-title h1 {
            font-size: 2.3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .red-title p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .blue-concepts {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 25px;
        }

        .blue-concepts h3 {
            font-size: 1.7em;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .measures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }

        .measure-card {
            padding: 18px;
            border-radius: 15px;
            border: 3px solid;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .ue-card       { background: linear-gradient(135deg, #28a745, #20c997); border-color:#1e7e34; color:white; }
        .fe-card       { background: linear-gradient(135deg, #6f42c1, #8e44ad); border-color:#563d7c; color:white; }
        .within-card   { background: linear-gradient(135deg, #17a2b8, #138496); border-color:#117a8b; color:white; }
        .practice-card { background: linear-gradient(135deg, #ffc107, #ff8800); border-color:#d39e00; color:#212529; }

        .measure-card h4 {
            font-size: 1.2em;
            margin-bottom: 10px;
            text-align: center;
        }

        .measure-card .formula {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 8px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-align: center;
            font-size: 0.85em;
        }

        .measure-card .description { margin-bottom: 10px; font-size:0.9em; }
        .measure-card .use-cases   { margin-bottom: 10px; font-style: italic; font-size:0.85em; }
        .measure-card .examples    { font-size:0.8em; border-top: 2px solid rgba(255,255,255,0.3); padding-top: 8px; }

        .interactive-section {
            padding: 25px;
            background: #f8f9fa;
        }

        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #007bff;
        }

        .scenario-display,
        .calculation-area {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .scenario-display { border-left: 5px solid #28a745; }
        .calculation-area { border-left: 5px solid #ffc107; }

        .btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin: 6px 4px;
            box-shadow: 0 4px 10px rgba(40,167,69,0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, #20c997, #28a745);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            box-shadow: 0 4px 10px rgba(108,117,125,0.3);
        }

        .data-block {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #007bff;
            margin: 10px 0 0 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size:0.9em;
        }

        .data-table th, .data-table td {
            border: 1px solid #dee2e6;
            padding: 6px 8px;
            text-align: center;
        }

        .options-grid {
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(230px,1fr));
            gap:10px;
            margin-top:10px;
        }

        .option-checkbox {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            border-radius: 10px;
            padding: 8px 10px;
            border: 2px solid #ced4da;
            display:flex;
            gap:8px;
            align-items:flex-start;
            font-size:0.85em;
        }

        .question-card {
            background:#f8f9fa;
            border-radius:10px;
            border:2px solid #dee2e6;
            padding:12px;
            margin:10px 0;
            font-size:0.9em;
        }

        .question-card h5 {
            margin-bottom:6px;
            color:#007bff;
            font-size:0.95em;
        }

        .question-input {
            margin-top:6px;
            display:flex;
            flex-wrap:wrap;
            align-items:center;
            gap:6px;
        }

        .question-input input {
            padding:6px 8px;
            border-radius:6px;
            border:1px solid #ced4da;
            min-width:100px;
        }

        .feedback {
            margin-top:4px;
            font-size:0.85em;
        }

        .feedback.correct {
            color:#155724;
        }

        .feedback.incorrect {
            color:#721c24;
        }

        .step-explanation {
            margin-top:6px;
            font-size:0.85em;
            background:white;
            border-radius:6px;
            padding:8px;
            border-left:3px solid #17a2b8;
        }

        .interpretation-box {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding:15px;
            border-radius:10px;
            margin:15px 0;
            border:2px solid #2196f3;
            font-size:0.9em;
        }

        .score-display {
            background: linear-gradient(135deg, #e83e8c, #d91a72);
            color:white;
            padding:15px;
            text-align:center;
            border-radius:12px;
            margin:10px 0 20px 0;
            border:3px solid #c7185d;
            box-shadow:0 4px 15px rgba(232,62,140,0.3);
            font-size:0.9em;
        }

        @media (max-width:768px) {
            .measures-grid { grid-template-columns:1fr; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="red-title">
        <h1>üìä Fixed Effects Estimation (Wooldridge 10.2)</h1>
        <p>Practice the within transformation and see how fixed effects remove time-invariant unobserved heterogeneity</p>
    </div>

    <div class="blue-concepts">
        <h3>üìò Key Ideas: Unobserved Effects & Fixed Effects</h3>
        <div class="measures-grid">
            <div class="measure-card ue-card">
                <h4>Unobserved Effects Model</h4>
                <div class="formula">
                    Y<sub>it</sub> = Œ≤‚ÇÄ + Œ≤‚ÇÅX<sub>it</sub> + a<sub>i</sub> + u<sub>it</sub>
                </div>
                <div class="description">
                    a<sub>i</sub> is a time-invariant unobserved effect (ability, firm culture, school quality). Pooled OLS treats a<sub>i</sub> as part of the error, which is a problem if a<sub>i</sub> is correlated with X<sub>it</sub>.
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> Wages with worker ability, firm productivity with management quality, student scores with school quality.
                </div>
                <div class="examples">
                    <strong>Example:</strong> High-ability workers both earn more and get more education ‚áí corr(educ<sub>it</sub>, a<sub>i</sub>) ‚â† 0.
                </div>
            </div>

            <div class="measure-card fe-card">
                <h4>Fixed Effects (Within) Estimator</h4>
                <div class="formula">
                    Y<sub>it</sub> ‚àí »≤<sub>i</sub> = Œ≤‚ÇÅ(X<sub>it</sub> ‚àí XÃÑ<sub>i</sub>) + (u<sub>it</sub> ‚àí ≈´<sub>i</sub>)
                </div>
                <div class="description">
                    Subtracting individual means from each variable (‚Äúwithin transformation‚Äù) removes a<sub>i</sub>. FE uses only within-i variation in X to estimate Œ≤‚ÇÅ.
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> When corr(X<sub>it</sub>, a<sub>i</sub>) ‚â† 0 but we have multiple periods per i.
                </div>
                <div class="examples">
                    <strong>Example:</strong> Estimate return to experience controlling for fixed ability via worker fixed effects.
                </div>
            </div>

            <div class="measure-card within-card">
                <h4>Two-Period Special Case</h4>
                <div class="formula">
                    ŒîY<sub>i</sub> = Œ≤‚ÇÅ ŒîX<sub>i</sub> + Œîu<sub>i</sub>  (T = 2)
                </div>
                <div class="description">
                    With exactly two time periods, the within transformation is equivalent to first differencing. The individual effect a<sub>i</sub> drops out of ŒîY<sub>i</sub>.
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> Before/after comparisons with panel data where the same units are observed twice.
                </div>
                <div class="examples">
                    <strong>Example:</strong> Change in log wage vs change in experience for each worker, controlling for fixed ability.
                </div>
            </div>

            <div class="measure-card practice-card">
                <h4>Brief Practical Discussion</h4>
                <div class="formula">
                    FE: Great for time-varying X, bad for time-invariant X
                </div>
                <div class="description">
                    Fixed effects remove all time-invariant factors, including observed ones (like gender, race, region). You cannot estimate their coefficients, but you can still estimate effects of time-varying variables without bias from a<sub>i</sub>.
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> When the main regressor varies over time and you worry about omitted time-invariant factors.
                </div>
                <div class="examples">
                    <strong>Rule of thumb:</strong> FE is attractive if your key X varies within individuals and is plausibly exogenous after removing a<sub>i</sub>.
                </div>
            </div>
        </div>
    </div>

    <div class="interactive-section">
        <div class="control-panel">
            <h3>üéÆ Interactive Practice: Fixed Effects with Two Periods</h3>
            <p>Each scenario gives a simple unobserved effects model with two time periods. Compute levels, changes, and see how the fixed effects transformation removes a<sub>i</sub> and identifies Œ≤‚ÇÅ from within-unit variation.</p>
            <button class="btn" onclick="generateScenario()">üìä Generate New Scenario</button>
            <button class="btn btn-secondary" onclick="resetPractice()">üîÑ Reset</button>
        </div>

        <div id="scenarioDisplay" class="scenario-display" style="display:none;">
            <h3 id="scenarioTitle">üìã Scenario</h3>
            <div id="scenarioDescription"></div>
            <div id="dataDisplay"></div>

            <div style="margin-top: 12px; padding: 12px; background:#f8f9fa; border-radius:10px; border-left:4px solid #6c757d;">
                <h4>‚öôÔ∏è Choose Tasks to Practice</h4>
                <p style="font-size:0.85em;color:#555;">
                    Use the model for an example individual i with T = 2. Fill in Y at t=0 and t=1, compute changes, and verify that ŒîY<sub>i</sub> = Œ≤‚ÇÅ ŒîX<sub>i</sub> (a<sub>i</sub> drops out).
                </p>
                <div class="options-grid">
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkBaseline" checked>
                        <div><strong>üèÅ Levels and means</strong><br>Compute Y<sub>i0</sub>, Y<sub>i1</sub>, and the individual mean »≤<sub>i</sub>.</div>
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkOtherMeans" checked>
                        <div><strong>üìä Changes (within variation)</strong><br>Compute ŒîX<sub>i</sub> and ŒîY<sub>i</sub>.</div>
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkDifference" checked>
                        <div><strong>üìâ FE relationship</strong><br>Check that ŒîY<sub>i</sub> = Œ≤‚ÇÅ ŒîX<sub>i</sub> and that a<sub>i</sub> has disappeared.</div>
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkInterpret" checked>
                        <div><strong>üß† Interpretation (open answer)</strong><br>Explain what Œ≤‚ÇÅ means as a within-unit effect and when FE helps.</div>
                    </label>
                </div>

                <button class="btn" onclick="generateQuestions()" style="margin-top:10px;">üßÆ Generate Questions</button>
            </div>
        </div>

        <div id="calculationArea" class="calculation-area" style="display:none;">
            <h3>üìù Questions & Feedback</h3>
            <div id="questionsContainer"></div>
            <button class="btn" onclick="checkAnswers()">‚úÖ Check Answers</button>
            <div id="interpretationDisplay"></div>
        </div>

        <div class="score-display">
            <h3>üéØ Practice Progress</h3>
            <div>Scenarios Practiced: <span id="scenariosCompleted">0</span></div>
        </div>
    </div>
</div>

<script>
    console.log("Fixed effects (10.2) practice loaded.");

    var currentScenario = null;
    var scenariosCompleted = 0;
    var currentQuestions = [];

    // Two-period FE scenarios: Y_it = beta0 + beta1 * X_it + a_i + u_it
    // Example individual i with t = 0,1 and simple numbers so FE is transparent.
    var scenarios = [
        {
            id: "wageExperience",
            title: "Log Wages, Experience, and Worker Ability",
            description: "You observe a worker in two years (t=0 and t=1). The log wage follows an unobserved effects model with worker ability a_i.",
            context: "See how the change in log wage depends on the change in experience when we difference out the fixed ability.",
            model: "Y_it = log(wage_it), X_it = exper_it (years of experience).",
            equation: "log(wage_it) = 1.00 + 0.04¬∑exper_it + a_i + u_it",
            beta0: 1.00,
            beta1: 0.04,
            a_i: 0.30,
            x0: 5,
            x1: 7,
            yUnits: "log wage",
            xName: "experience (years)",
            expertInterpretation:
                "Here Œ≤‚ÇÅ = 0.04 is a within-worker return to an extra year of experience: for a given worker, an increase of one year of experience raises log wage by about 0.04 (‚âà 4%), after removing the worker‚Äôs fixed ability a_i."
        },
        {
            id: "firmCapital",
            title: "Log Output, Capital, and Firm Productivity",
            description: "You observe a firm at two dates (t=0 and t=1). Output depends on capital, a firm fixed effect a_i (management quality), and an idiosyncratic error.",
            context: "Use a two-period FE transformation to eliminate unobserved management quality.",
            model: "Y_it = log(output_it), X_it = log(K_it) (capital).",
            equation: "log(output_it) = 2.00 + 0.50¬∑log(K_it) + a_i + u_it",
            beta0: 2.00,
            beta1: 0.50,
            a_i: -0.40,
            x0: 1.00,   // log K at t=0
            x1: 1.20,   // log K at t=1
            yUnits: "log output",
            xName: "log(capital)",
            expertInterpretation:
                "Œ≤‚ÇÅ = 0.50 is the within-firm elasticity of output with respect to capital: a 1% increase in K is associated with about a 0.5% increase in output, holding fixed the firm-specific productivity a_i."
        },
        {
            id: "classSizeScores",
            title: "Test Scores, Class Size, and School Quality",
            description: "A school is observed for two cohorts (t=0 and t=1). Average test scores depend on class size, school fixed quality a_i, and shocks.",
            context: "Show how a two-period FE transformation uses changes in class size and scores to eliminate the fixed school effect.",
            model: "Y_it = avg test score_it, X_it = class_size_it (students per class).",
            equation: "score_it = 50 ‚àí 2¬∑class_size_it + a_i + u_it",
            beta0: 50,
            beta1: -2,
            a_i: 10,
            x0: 25,
            x1: 20,
            yUnits: "test score points",
            xName: "class size (students)",
            expertInterpretation:
                "Œ≤‚ÇÅ = ‚àí2 means that, within a given school, reducing average class size by one student is associated with about a 2-point increase in test scores, after netting out the school‚Äôs fixed quality a_i."
        }
    ];

    function generateScenario() {
        var idx = Math.floor(Math.random() * scenarios.length);
        currentScenario = scenarios[idx];
        console.log("Scenario:", currentScenario.id);

        currentQuestions = [];

        document.getElementById("scenarioDisplay").style.display = "block";
        document.getElementById("calculationArea").style.display = "none";
        document.getElementById("interpretationDisplay").innerHTML = "";
        document.getElementById("questionsContainer").innerHTML = "";

        document.getElementById("scenarioTitle").textContent = "üìä " + currentScenario.title;

        var descHtml = "";
        descHtml += '<div class="data-block">';
        descHtml += '<h4>üìã Panel Context (T = 2):</h4>';
        descHtml += '<p style="margin-top:8px;">' + currentScenario.description + '</p>';
        descHtml += '<p style="margin-top:8px;font-style:italic;color:#6c757d;"><strong>Goal:</strong> ' +
                    currentScenario.context + '</p>';
        descHtml += '</div>';
        document.getElementById("scenarioDescription").innerHTML = descHtml;

        displayData(currentScenario);

        document.getElementById("chkBaseline").checked = true;
        document.getElementById("chkOtherMeans").checked = true;
        document.getElementById("chkDifference").checked = true;
        document.getElementById("chkInterpret").checked = true;
    }

    function displayData(scenario) {
        var s = scenario;

        // Compute Y for t=0,1 using the model and u_it = 0 for illustration
        var y0 = s.beta0 + s.beta1 * s.x0 + s.a_i;
        var y1 = s.beta0 + s.beta1 * s.x1 + s.a_i;
        var ybar = (y0 + y1) / 2;
        var xbar = (s.x0 + s.x1) / 2;
        var dX = s.x1 - s.x0;
        var dY = y1 - y0;

        var html = "";
        html += '<h4>üìã Unobserved Effects Model (Individual i, Two Periods)</h4>';
        html += '<div class="data-block">';
        html += '<p><strong>Outcome and regressor:</strong> ' + s.model + '</p>';

        html += '<p style="margin-top:8px;"><strong>Model with individual effect a<sub>i</sub>:</strong></p>';
        html += '<p style="margin-top:4px; font-family:Courier New, monospace; font-size:1.0em;">';
        html += s.equation;
        html += '</p>';

        html += '<p style="margin-top:8px;font-size:0.9em;">';
        html += 'For a particular unit i, we observe two periods (t = 0, 1). The unobserved effect a<sub>i</sub> is constant over time, but X<sub>it</sub> changes.';
        html += '</p>';

        html += '<table class="data-table" style="margin-top:12px;">';
        html += '<thead><tr><th>Period t</th><th>X_it (' + s.xName + ')</th><th>Y_it (pred, ignoring u_it)</th></tr></thead><tbody>';
        html += '<tr><td>0</td><td>' + s.x0.toFixed(2) + '</td><td>' + y0.toFixed(2) + '</td></tr>';
        html += '<tr><td>1</td><td>' + s.x1.toFixed(2) + '</td><td>' + y1.toFixed(2) + '</td></tr>';
        html += '</tbody></table>';

        html += '<p style="margin-top:10px;font-size:0.9em;">';
        html += '<strong>Two-period FE (first difference):</strong> For this unit, ŒîY<sub>i</sub> = Y<sub>i1</sub> ‚àí Y<sub>i0</sub> and ŒîX<sub>i</sub> = X<sub>i1</sub> ‚àí X<sub>i0</sub>. ';
        html += 'The FE model implies ŒîY<sub>i</sub> = Œ≤‚ÇÅ¬∑ŒîX<sub>i</sub> + Œîu<sub>i</sub>, with a<sub>i</sub> gone.';
        html += '</p>';

        html += '<p style="margin-top:6px;font-size:0.9em;">';
        html += '<strong>For this example unit (ignoring u_it):</strong> ŒîX<sub>i</sub> = ' + dX.toFixed(2) +
                ', ŒîY<sub>i</sub> = ' + dY.toFixed(2) + ', and Œ≤‚ÇÅ¬∑ŒîX<sub>i</sub> = ' +
                (s.beta1 * dX).toFixed(2) + '.';
        html += '</p>';

        document.getElementById("dataDisplay").innerHTML = html;
    }

    function generateQuestions() {
        if (!currentScenario) {
            alert("Please generate a scenario first.");
            return;
        }

        currentQuestions = [];
        var container = document.getElementById("questionsContainer");
        container.innerHTML = "";

        var chkBaseline   = document.getElementById("chkBaseline").checked;
        var chkOtherMeans = document.getElementById("chkOtherMeans").checked;
        var chkDifference = document.getElementById("chkDifference").checked;
        var chkInterpret  = document.getElementById("chkInterpret").checked;

        var s = currentScenario;

        // Recompute basic quantities
        var y0 = s.beta0 + s.beta1 * s.x0 + s.a_i;
        var y1 = s.beta0 + s.beta1 * s.x1 + s.a_i;
        var ybar = (y0 + y1) / 2;
        var xbar = (s.x0 + s.x1) / 2;
        var dX = s.x1 - s.x0;
        var dY = y1 - y0;
        var beta1dX = s.beta1 * dX;

        if (chkBaseline) {
            currentQuestions.push({
                conceptId: "y0",
                type: "numeric",
                title: "üèÅ Level at t = 0",
                prompt: "Compute Y_i0 using the model (ignore u_it).",
                correctValue: y0,
                unitHint: "(" + s.yUnits + ")"
            });
            currentQuestions.push({
                conceptId: "y1",
                type: "numeric",
                title: "üèÅ Level at t = 1",
                prompt: "Compute Y_i1 using the model (ignore u_it).",
                correctValue: y1,
                unitHint: "(" + s.yUnits + ")"
            });
            currentQuestions.push({
                conceptId: "yMean",
                type: "numeric",
                title: "üèÅ Individual mean »≤_i",
                prompt: "Compute the mean of Y for this unit: »≤_i = (Y_i0 + Y_i1)/2.",
                correctValue: ybar,
                unitHint: "(" + s.yUnits + ")"
            });
        }

        if (chkOtherMeans) {
            currentQuestions.push({
                conceptId: "dX",
                type: "numeric",
                title: "üìä Change in X: ŒîX_i",
                prompt: "Compute ŒîX_i = X_i1 ‚àí X_i0.",
                correctValue: dX,
                unitHint: "(" + s.xName + ")"
            });
            currentQuestions.push({
                conceptId: "dY",
                type: "numeric",
                title: "üìä Change in Y: ŒîY_i",
                prompt: "Compute ŒîY_i = Y_i1 ‚àí Y_i0 (using your Y_i0 and Y_i1, ignoring u_it).",
                correctValue: dY,
                unitHint: "(" + s.yUnits + ")"
            });
        }

        if (chkDifference) {
            currentQuestions.push({
                conceptId: "betaDX",
                type: "numeric",
                title: "üìâ Œ≤‚ÇÅ¬∑ŒîX_i",
                prompt: "Compute Œ≤‚ÇÅ¬∑ŒîX_i using Œ≤‚ÇÅ from the model and your ŒîX_i.",
                correctValue: beta1dX,
                unitHint: "(" + s.yUnits + ")"
            });
            currentQuestions.push({
                conceptId: "aiGone",
                type: "numeric",
                title: "üìâ Does a_i appear in ŒîY_i?",
                prompt: "Answer 1 if a_i is still in the differenced equation ŒîY_i = Œ≤‚ÇÅŒîX_i + Œîu_i, and 0 if a_i has disappeared.",
                correctValue: 0,
                unitHint: "(1 = yes, 0 = no)"
            });
        }

        if (chkInterpret) {
            currentQuestions.push({
                conceptId: "interpret",
                type: "open",
                title: "üß† Interpretation of Œ≤‚ÇÅ under fixed effects",
                prompt: "In words, interpret Œ≤‚ÇÅ as a within-unit effect in this scenario. Explain why fixed effects help when a_i is correlated with X_it, and what types of variables you cannot estimate with FE.",
                correctText: ""
            });
        }

        if (currentQuestions.length === 0) {
            container.innerHTML = "<p>No tasks selected. Tick at least one box.</p>";
            document.getElementById("calculationArea").style.display = "block";
            return;
        }

        var html = "";
        for (var j = 0; j < currentQuestions.length; j++) {
            html += renderQuestionCard(currentQuestions[j], j);
        }
        container.innerHTML = html;

        document.getElementById("calculationArea").style.display = "block";
        document.getElementById("interpretationDisplay").innerHTML = "";
    }

    function renderQuestionCard(q, index) {
        var html = "";
        html += '<div class="question-card">';
        html += '<h5>' + q.title + '</h5>';
        html += '<p>' + q.prompt + '</p>';
        html += '<div class="question-input">';
        html += '<label for="answer_' + index + '"><strong>Your answer:</strong></label>';
        html += '<input type="text" id="answer_' + index + '">';
        if (q.unitHint) {
            html += '<span>' + q.unitHint + '</span>';
        }
        html += '</div>';
        html += '<div id="feedback_' + index + '" class="feedback"></div>';
        html += '<div id="explain_' + index + '" class="step-explanation" style="display:none;"></div>';
        html += '</div>';
        return html;
    }

    function checkAnswers() {
        if (currentQuestions.length === 0) {
            alert("No questions to check. Generate questions first.");
            return;
        }

        var numCorrect = 0;

        for (var i = 0; i < currentQuestions.length; i++) {
            var q = currentQuestions[i];
            var ansInput = document.getElementById("answer_" + i);
            var feedbackEl = document.getElementById("feedback_" + i);
            var explainEl = document.getElementById("explain_" + i);

            if (!ansInput) continue;

            var userRaw = ansInput.value.trim();
            if (userRaw === "") {
                feedbackEl.textContent = "Please enter an answer.";
                feedbackEl.className = "feedback";
                explainEl.style.display = "none";
                continue;
            }

            if (q.type === "numeric") {
                var userVal = parseFloat(userRaw);
                if (isNaN(userVal)) {
                    feedbackEl.textContent = "Please enter a numeric answer.";
                    feedbackEl.className = "feedback";
                    explainEl.style.display = "none";
                    continue;
                }
                var correct = q.correctValue;
                var ok = isCloseNumeric(userVal, correct);
                if (ok) {
                    numCorrect++;
                    feedbackEl.textContent = "‚úÖ Correct (expected about " + correct.toFixed(2) + ").";
                    feedbackEl.className = "feedback correct";
                } else {
                    feedbackEl.textContent = "‚ùå Not quite. A good answer is about " + correct.toFixed(2) + ".";
                    feedbackEl.className = "feedback incorrect";
                }
            } else if (q.type === "open") {
                feedbackEl.textContent = "üìù Thanks for your explanation. Compare it with the expert interpretation below.";
                feedbackEl.className = "feedback";
            }

            explainEl.innerHTML = getExplanationHtml(q);
            explainEl.style.display = "block";
        }

        var interpLines = [];
        interpLines.push("‚Ä¢ You answered " + numCorrect + " out of " + currentQuestions.length + " auto-graded questions correctly (within tolerance).");
        interpLines.push("‚Ä¢ Key identity (T=2): ŒîY_i = Œ≤‚ÇÅ ŒîX_i + Œîu_i, and a_i drops out. FE uses within-unit variation in X to estimate Œ≤‚ÇÅ.");
        document.getElementById("interpretationDisplay").innerHTML =
            '<div class="interpretation-box"><h4>üß† Summary of This Practice Round</h4>' +
            interpLines.join("<br>") + '</div>';

        scenariosCompleted++;
        document.getElementById("scenariosCompleted").textContent = String(scenariosCompleted);
    }

    function isCloseNumeric(userVal, correctVal) {
        var diff = Math.abs(userVal - correctVal);
        var tol = Math.max(0.1, Math.abs(correctVal) * 0.03); // ¬±3% or at least 0.1
        return diff <= tol;
    }

    function getExplanationHtml(q) {
        if (!currentScenario) return "";

        var s = currentScenario;
        var y0 = s.beta0 + s.beta1 * s.x0 + s.a_i;
        var y1 = s.beta0 + s.beta1 * s.x1 + s.a_i;
        var ybar = (y0 + y1) / 2;
        var dX = s.x1 - s.x0;
        var dY = y1 - y0;
        var beta1dX = s.beta1 * dX;

        var html = "<strong>How to think about this:</strong><br>";

        if (q.conceptId === "y0") {
            html += "Plug t=0 values into the model:<br>";
            html += "Y_i0 = Œ≤‚ÇÄ + Œ≤‚ÇÅ X_i0 + a_i = "
                  + s.beta0.toFixed(2) + " + "
                  + s.beta1.toFixed(2) + "¬∑(" + s.x0.toFixed(2) + ") + "
                  + "a_i (" + s.a_i.toFixed(2) + ") = "
                  + y0.toFixed(2) + ".";
        } else if (q.conceptId === "y1") {
            html += "Plug t=1 values into the model:<br>";
            html += "Y_i1 = Œ≤‚ÇÄ + Œ≤‚ÇÅ X_i1 + a_i = "
                  + s.beta0.toFixed(2) + " + "
                  + s.beta1.toFixed(2) + "¬∑(" + s.x1.toFixed(2) + ") + "
                  + "a_i (" + s.a_i.toFixed(2) + ") = "
                  + y1.toFixed(2) + ".";
        } else if (q.conceptId === "yMean") {
            html += "The individual mean is just the average across the two periods:<br>";
            html += "»≤_i = (Y_i0 + Y_i1)/2 = ("
                  + y0.toFixed(2) + " + " + y1.toFixed(2) + ")/2 = "
                  + ybar.toFixed(2) + ".";
        } else if (q.conceptId === "dX") {
            html += "Compute the change in X between t=0 and t=1:<br>";
            html += "ŒîX_i = X_i1 ‚àí X_i0 = "
                  + s.x1.toFixed(2) + " ‚àí " + s.x0.toFixed(2)
                  + " = " + dX.toFixed(2) + ".";
        } else if (q.conceptId === "dY") {
            html += "Compute the change in Y between t=0 and t=1:<br>";
            html += "ŒîY_i = Y_i1 ‚àí Y_i0 = "
                  + y1.toFixed(2) + " ‚àí " + y0.toFixed(2)
                  + " = " + dY.toFixed(2) + ".";
        } else if (q.conceptId === "betaDX") {
            html += "Two-period FE says ŒîY_i ‚âà Œ≤‚ÇÅ¬∑ŒîX_i (plus Œîu_i).<br>";
            html += "Here Œ≤‚ÇÅ¬∑ŒîX_i = "
                  + s.beta1.toFixed(2) + "¬∑(" + dX.toFixed(2) + ") = "
                  + beta1dX.toFixed(2) + ".<br>";
            html += "With u_it set to zero in this example, ŒîY_i equals Œ≤‚ÇÅ¬∑ŒîX_i exactly.";
        } else if (q.conceptId === "aiGone") {
            html += "Start from Y_it = Œ≤‚ÇÄ + Œ≤‚ÇÅ X_it + a_i + u_it.<br>";
            html += "Take the difference: ŒîY_i = (Y_i1 ‚àí Y_i0) = Œ≤‚ÇÅ(X_i1 ‚àí X_i0) + (u_i1 ‚àí u_i0).<br>";
            html += "The a_i term is the same in both periods, so it cancels: it does not appear in ŒîY_i.";
        } else if (q.conceptId === "interpret") {
            html += "<em>" + s.expertInterpretation + "</em><br><br>";
            html += "FE is helpful when a_i is correlated with X_it. By removing a_i, the remaining regressor variation is within-unit over time. ";
            html += "But FE cannot identify the effect of purely time-invariant regressors (like gender or a time-constant policy dummy), because those drop out in the within transformation.";
        } else {
            html += "Remember: FE eliminates all time-constant components of the error, including a_i, and estimates Œ≤‚ÇÅ from variation of X within i over time.";
        }

        return html;
    }

    function resetPractice() {
        currentScenario = null;
        currentQuestions = [];
        scenariosCompleted = 0;
        document.getElementById("scenariosCompleted").textContent = "0";
        document.getElementById("scenarioDisplay").style.display = "none";
        document.getElementById("calculationArea").style.display = "none";
        document.getElementById("questionsContainer").innerHTML = "";
        document.getElementById("interpretationDisplay").innerHTML = "";
        document.getElementById("dataDisplay").innerHTML = "";
        document.getElementById("scenarioDescription").innerHTML = "";
        console.log("Fixed effects practice reset.");
    }

    document.getElementById("scenariosCompleted").textContent = "0";
</script>
</body>
</html>
