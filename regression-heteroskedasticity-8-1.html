<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Heteroskedasticity and OLS (Wooldridge 8.1)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .red-title {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 5px solid #a71e2a;
        }

        .red-title h1 {
            font-size: 2.3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .red-title p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .blue-concepts {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 25px;
        }

        .blue-concepts h3 {
            font-size: 1.7em;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .measures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }

        .measure-card {
            padding: 18px;
            border-radius: 15px;
            border: 3px solid;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .hetero-card  { background: linear-gradient(135deg, #28a745, #20c997); border-color:#1e7e34; color:white; }
        .ols-card     { background: linear-gradient(135deg, #6f42c1, #8e44ad); border-color:#563d7c; color:white; }
        .robust-card  { background: linear-gradient(135deg, #17a2b8, #138496); border-color:#117a8b; color:white; }
        .pitfall-card { background: linear-gradient(135deg, #ffc107, #ff8800); border-color:#d39e00; color:#212529; }

        .measure-card h4 {
            font-size: 1.2em;
            margin-bottom: 10px;
            text-align: center;
        }

        .measure-card .formula {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 8px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-align: center;
            font-size: 0.85em;
        }

        .measure-card .description { margin-bottom: 10px; font-size:0.9em; }
        .measure-card .use-cases   { margin-bottom: 10px; font-style: italic; font-size:0.85em; }
        .measure-card .examples    { font-size:0.8em; border-top: 2px solid rgba(255,255,255,0.3); padding-top: 8px; }

        .interactive-section {
            padding: 25px;
            background: #f8f9fa;
        }

        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #007bff;
        }

        .scenario-display,
        .calculation-area {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .scenario-display { border-left: 5px solid #28a745; }
        .calculation-area { border-left: 5px solid #ffc107; }

        .btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin: 6px 4px;
            box-shadow: 0 4px 10px rgba(40,167,69,0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, #20c997, #28a745);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            box-shadow: 0 4px 10px rgba(108,117,125,0.3);
        }

        .data-block {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #007bff;
            margin: 10px 0 0 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size:0.9em;
        }

        .data-table th, .data-table td {
            border: 1px solid #dee2e6;
            padding: 6px 8px;
            text-align: center;
        }

        .options-grid {
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(230px,1fr));
            gap:10px;
            margin-top:10px;
        }

        .option-checkbox {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            border-radius: 10px;
            padding: 8px 10px;
            border: 2px solid #ced4da;
            display:flex;
            gap:8px;
            align-items:flex-start;
            font-size:0.85em;
        }

        .question-card {
            background:#f8f9fa;
            border-radius:10px;
            border:2px solid #dee2e6;
            padding:12px;
            margin:10px 0;
            font-size:0.9em;
        }

        .question-card h5 {
            margin-bottom:6px;
            color:#007bff;
            font-size:0.95em;
        }

        .question-input {
            margin-top:6px;
            display:flex;
            flex-wrap:wrap;
            align-items:center;
            gap:6px;
        }

        .question-input input {
            padding:6px 8px;
            border-radius:6px;
            border:1px solid #ced4da;
            min-width:100px;
        }

        .feedback {
            margin-top:4px;
            font-size:0.85em;
        }

        .feedback.correct {
            color:#155724;
        }

        .feedback.incorrect {
            color:#721c24;
        }

        .step-explanation {
            margin-top:6px;
            font-size:0.85em;
            background:white;
            border-radius:6px;
            padding:8px;
            border-left:3px solid #17a2b8;
        }

        .interpretation-box {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding:15px;
            border-radius:10px;
            margin:15px 0;
            border:2px solid #2196f3;
            font-size:0.9em;
        }

        .score-display {
            background: linear-gradient(135deg, #e83e8c, #d91a72);
            color:white;
            padding:15px;
            text-align:center;
            border-radius:12px;
            margin:10px 0 20px 0;
            border:3px solid #c7185d;
            box-shadow:0 4px 15px rgba(232,62,140,0.3);
            font-size:0.9em;
        }

        @media (max-width:768px) {
            .measures-grid { grid-template-columns:1fr; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="red-title">
        <h1>üìä Heteroskedasticity and OLS (Wooldridge 8.1)</h1>
        <p>Practice understanding what heteroskedasticity does to OLS and how robust standard errors change inference</p>
    </div>

    <div class="blue-concepts">
        <h3>üìò Key Ideas About Heteroskedasticity</h3>
        <div class="measures-grid">
            <div class="measure-card hetero-card">
                <h4>What Is Heteroskedasticity?</h4>
                <div class="formula">
                    Var(u | X) = œÉ¬≤(X) (not constant)
                </div>
                <div class="description">
                    Error variance changes with X: some observations are noisier than others. For example, richer households may have more variable consumption.
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> Cross-section data with outcomes that scale with size: income, sales, prices, expenditures.
                </div>
                <div class="examples">
                    <strong>Example:</strong> Var(u | income) increases with income in a wage regression.
                </div>
            </div>

            <div class="measure-card ols-card">
                <h4>What OLS Still Gets Right</h4>
                <div class="formula">
                    E(Œ≤ÃÇ | X) = Œ≤  (still unbiased/consistent)
                </div>
                <div class="description">
                    Under the usual exogeneity assumptions, heteroskedasticity does <u>not</u> bias Œ≤ÃÇ and does not change OLS fitted values or R¬≤.
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> You can still interpret the coefficients as usual ceteris paribus effects.
                </div>
                <div class="examples">
                    <strong>Example:</strong> The estimated return to education is still valid as an average effect, but its standard error may be wrong.
                </div>
            </div>

            <div class="measure-card robust-card">
                <h4>What Heteroskedasticity Breaks</h4>
                <div class="formula">
                    Usual SEs, t, and F are no longer valid
                </div>
                <div class="description">
                    The usual homoskedastic standard error formula is wrong under heteroskedasticity. t and F tests based on it can be misleading.
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> Compute heteroskedasticity-robust standard errors (White/Huber-White).
                </div>
                <div class="examples">
                    <strong>Example:</strong> A coefficient may look significant with usual SEs but become insignificant with robust SEs.
                </div>
            </div>

            <div class="measure-card pitfall-card">
                <h4>Robust Inference</h4>
                <div class="formula">
                    t<sub>robust</sub> = Œ≤ÃÇ / se<sub>robust</sub>(Œ≤ÃÇ)
                </div>
                <div class="description">
                    Robust SEs fix inference (asymptotically) but do not change Œ≤ÃÇ. You should report robust t-statistics and confidence intervals.
                </div>
                <div class="use-cases">
                    <strong>Use:</strong> Any cross-section regression unless you have strong reasons to assume homoskedasticity.
                </div>
                <div class="examples">
                    <strong>Example:</strong> 95% CI: Œ≤ÃÇ ¬± 1.96¬∑se<sub>robust</sub>(Œ≤ÃÇ).
                </div>
            </div>
        </div>
    </div>

    <div class="interactive-section">
        <div class="control-panel">
            <h3>üéÆ Interactive Practice: Heteroskedasticity & Robust SEs</h3>
            <p>Each scenario gives you regression output with both usual and heteroskedasticity-robust standard errors. Compute t-statistics, confidence intervals, and see how inference changes.</p>
            <button class="btn" onclick="generateScenario()">üìä Generate New Scenario</button>
            <button class="btn btn-secondary" onclick="resetPractice()">üîÑ Reset</button>
        </div>

        <div id="scenarioDisplay" class="scenario-display" style="display:none;">
            <h3 id="scenarioTitle">üìã Scenario</h3>
            <div id="scenarioDescription"></div>
            <div id="dataDisplay"></div>

            <div style="margin-top: 12px; padding: 12px; background:#f8f9fa; border-radius:10px; border-left:4px solid #6c757d;">
                <h4>‚öôÔ∏è Choose Tasks to Practice</h4>
                <p style="font-size:0.85em;color:#555;">
                    Use the coefficient and the two standard errors (usual vs robust). Focus on t-statistics, 95% confidence intervals, and whether the variable is statistically significant.
                </p>
                <div class="options-grid">
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkBaseline" checked>
                        <div><strong>üèÅ t-statistics</strong><br>Compute t with usual and robust SEs.</div>
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkOtherMeans" checked>
                        <div><strong>üìä 95% confidence intervals</strong><br>Compute Œ≤ÃÇ ¬± 1.96¬∑SE using usual and robust SEs.</div>
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkDifference" checked>
                        <div><strong>üìâ Significance comparison</strong><br>See if significance changes when using robust SEs.</div>
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="chkInterpret" checked>
                        <div><strong>üß† Interpretation (open answer)</strong><br>Explain what heteroskedasticity does in this context.</div>
                    </label>
                </div>

                <button class="btn" onclick="generateQuestions()" style="margin-top:10px;">üßÆ Generate Questions</button>
            </div>
        </div>

        <div id="calculationArea" class="calculation-area" style="display:none;">
            <h3>üìù Questions & Feedback</h3>
            <div id="questionsContainer"></div>
            <button class="btn" onclick="checkAnswers()">‚úÖ Check Answers</button>
            <div id="interpretationDisplay"></div>
        </div>

        <div class="score-display">
            <h3>üéØ Practice Progress</h3>
            <div>Scenarios Practiced: <span id="scenariosCompleted">0</span></div>
        </div>
    </div>
</div>

<script>
    console.log("Heteroskedasticity (8.1) practice loaded.");

    var currentScenario = null;
    var scenariosCompleted = 0;
    var currentQuestions = [];

    // Scenarios: each gives Œ≤ÃÇ, usual SE, robust SE for a key regressor
    var scenarios = [
        {
            id: "wageEduc",
            title: "Return to Education in a Wage Equation",
            description: "You estimate a log wage equation in a cross-section of workers. You suspect that the variance of the error term increases with education and income.",
            context: "Compare usual vs robust standard errors for the return to education and see whether significance changes.",
            equation: "log(wage) = 0.5 + 0.08¬∑educ + 0.02¬∑exper + other controls + u",
            regressorName: "educ",
            regressorLabel: "Years of schooling (educ)",
            betaHat: 0.080,
            seUsual: 0.015,
            seRobust: 0.028,
            expertInterpretation:
                "The OLS estimate of the return to education is about 0.08, or 8%. Under homoskedasticity, the t-statistic is large and education appears highly significant. But with heteroskedasticity-robust standard errors, the standard error roughly doubles and the t-statistic becomes much smaller. Heteroskedasticity does not change the estimate 0.08, but it does change how confident we are about it."
        },
        {
            id: "houseSize",
            title: "House Price and Square Footage",
            description: "You regress house price on square footage and other controls. More expensive houses have more volatile prices, creating heteroskedasticity.",
            context: "Compute t-statistics and 95% CIs for the effect of square footage using usual and robust SEs.",
            equation: "price = 40 + 0.09¬∑sqft + other controls + u   (price in $1,000s)",
            regressorName: "sqft",
            regressorLabel: "Square footage of the house (sqft)",
            betaHat: 0.090,
            seUsual: 0.012,
            seRobust: 0.020,
            expertInterpretation:
                "Each additional square foot of house size increases the expected price by about $90 (0.09 in thousands). Under heteroskedasticity, the usual standard errors are too optimistic: the robust standard error is noticeably larger, so the robust confidence interval is wider, even though the point estimate is unchanged."
        },
        {
            id: "lpmEmploy",
            title: "Linear Probability Model for Employment",
            description: "You estimate a linear probability model (LPM) for employment with a training program dummy and other regressors. Because the dependent variable is binary, the model is automatically heteroskedastic.",
            context: "Focus on the effect of the training program and compare usual vs robust inference.",
            equation: "employed = 0.55 + 0.18¬∑train + other controls + u",
            regressorName: "train",
            regressorLabel: "train = 1 if worker participated in job training, 0 otherwise",
            betaHat: 0.180,
            seUsual: 0.040,
            seRobust: 0.060,
            expertInterpretation:
                "The coefficient 0.18 on train means that the training program is associated with an 18 percentage point higher employment probability. But because the LPM is heteroskedastic by construction, we should rely on robust standard errors. Using robust SEs, the t-statistic falls from about 4.5 to about 3.0, still significant but less impressive."
        }
    ];

    function generateScenario() {
        var idx = Math.floor(Math.random() * scenarios.length);
        currentScenario = scenarios[idx];
        console.log("Scenario:", currentScenario.id);

        currentQuestions = [];

        document.getElementById("scenarioDisplay").style.display = "block";
        document.getElementById("calculationArea").style.display = "none";
        document.getElementById("interpretationDisplay").innerHTML = "";
        document.getElementById("questionsContainer").innerHTML = "";

        document.getElementById("scenarioTitle").textContent = "üìä " + currentScenario.title;

        var descHtml = "";
        descHtml += '<div class="data-block">';
        descHtml += '<h4>üìã Context:</h4>';
        descHtml += '<p style="margin-top:8px;">' + currentScenario.description + '</p>';
        descHtml += '<p style="margin-top:8px;font-style:italic;color:#6c757d;"><strong>Goal:</strong> ' +
                    currentScenario.context + '</p>';
        descHtml += '</div>';
        document.getElementById("scenarioDescription").innerHTML = descHtml;

        displayData(currentScenario);

        document.getElementById("chkBaseline").checked = true;
        document.getElementById("chkOtherMeans").checked = true;
        document.getElementById("chkDifference").checked = true;
        document.getElementById("chkInterpret").checked = true;
    }

    function displayData(scenario) {
        var html = "";
        html += '<h4>üìã Estimated Coefficient with Usual and Robust SEs</h4>';
        html += '<div class="data-block">';
        html += '<p><strong>Model:</strong></p>';
        html += '<p style="margin-top:8px; font-family:Courier New, monospace; font-size:1.0em;">';
        html += scenario.equation;
        html += '</p>';

        html += '<table class="data-table" style="margin-top:12px;">';
        html += '<thead><tr><th>Regressor</th><th>Œ≤ÃÇ</th><th>Usual SE</th><th>Robust SE</th></tr></thead><tbody>';
        html += '<tr>';
        html += '<td>' + scenario.regressorLabel + '</td>';
        html += '<td>' + scenario.betaHat.toFixed(3) + '</td>';
        html += '<td>' + scenario.seUsual.toFixed(3) + '</td>';
        html += '<td>' + scenario.seRobust.toFixed(3) + '</td>';
        html += '</tr>';
        html += '</tbody></table>';

        html += '<p style="margin-top:10px;font-size:0.9em;">';
        html += '<strong>Reminder:</strong> The coefficient Œ≤ÃÇ is the same under homoskedastic and heteroskedastic assumptions. What changes is the formula for the standard error.';
        html += '</p>';

        html += '</div>';

        document.getElementById("dataDisplay").innerHTML = html;
    }

    function generateQuestions() {
        if (!currentScenario) {
            alert("Please generate a scenario first.");
            return;
        }

        currentQuestions = [];
        var container = document.getElementById("questionsContainer");
        container.innerHTML = "";

        var chkBaseline   = document.getElementById("chkBaseline").checked;
        var chkOtherMeans = document.getElementById("chkOtherMeans").checked;
        var chkDifference = document.getElementById("chkDifference").checked;
        var chkInterpret  = document.getElementById("chkInterpret").checked;

        var s = currentScenario;
        var beta = s.betaHat;
        var seU = s.seUsual;
        var seR = s.seRobust;

        var tU = beta / seU;
        var tR = beta / seR;
        var ciU_low = beta - 1.96 * seU;
        var ciU_high = beta + 1.96 * seU;
        var ciR_low = beta - 1.96 * seR;
        var ciR_high = beta + 1.96 * seR;

        if (chkBaseline) {
            currentQuestions.push({
                conceptId: "tUsual",
                type: "numeric",
                title: "üèÅ Usual t-statistic (Homoskedastic SE)",
                prompt: "Compute the t-statistic for " + s.regressorName +
                        " using the usual standard error: t = Œ≤ÃÇ / se_usual.",
                correctValue: tU,
                unitHint: ""
            });
            currentQuestions.push({
                conceptId: "tRobust",
                type: "numeric",
                title: "üìä Robust t-statistic",
                prompt: "Compute the t-statistic for " + s.regressorName +
                        " using the robust standard error: t = Œ≤ÃÇ / se_robust.",
                correctValue: tR,
                unitHint: ""
            });
        }

        if (chkOtherMeans) {
            currentQuestions.push({
                conceptId: "ciUsualLow",
                type: "numeric",
                title: "üìä 95% CI (Usual SE) - Lower Endpoint",
                prompt: "Compute the lower endpoint of the 95% confidence interval using the usual standard error: Œ≤ÃÇ ‚àí 1.96¬∑se_usual.",
                correctValue: ciU_low,
                unitHint: ""
            });
            currentQuestions.push({
                conceptId: "ciUsualHigh",
                type: "numeric",
                title: "üìä 95% CI (Usual SE) - Upper Endpoint",
                prompt: "Compute the upper endpoint of the 95% confidence interval using the usual standard error: Œ≤ÃÇ + 1.96¬∑se_usual.",
                correctValue: ciU_high,
                unitHint: ""
            });
        }

        if (chkDifference) {
            currentQuestions.push({
                conceptId: "ciRobustLow",
                type: "numeric",
                title: "üìâ 95% CI (Robust SE) - Lower Endpoint",
                prompt: "Compute the lower endpoint of the 95% confidence interval using the robust standard error: Œ≤ÃÇ ‚àí 1.96¬∑se_robust.",
                correctValue: ciR_low,
                unitHint: ""
            });
            currentQuestions.push({
                conceptId: "ciRobustHigh",
                type: "numeric",
                title: "üìâ 95% CI (Robust SE) - Upper Endpoint",
                prompt: "Compute the upper endpoint of the 95% confidence interval using the robust standard error: Œ≤ÃÇ + 1.96¬∑se_robust.",
                correctValue: ciR_high,
                unitHint: ""
            });
        }

        if (chkInterpret) {
            currentQuestions.push({
                conceptId: "interpret",
                type: "open",
                title: "üß† Interpretation (Open Answer)",
                prompt: "Explain in words how heteroskedasticity affects the interpretation of this coefficient and why we might prefer the robust standard error in this context. Then compare your explanation with the expert wording below.",
                correctText: ""
            });
        }

        if (currentQuestions.length === 0) {
            container.innerHTML = "<p>No tasks selected. Tick at least one box.</p>";
            document.getElementById("calculationArea").style.display = "block";
            return;
        }

        var html = "";
        for (var j = 0; j < currentQuestions.length; j++) {
            html += renderQuestionCard(currentQuestions[j], j);
        }
        container.innerHTML = html;

        document.getElementById("calculationArea").style.display = "block";
        document.getElementById("interpretationDisplay").innerHTML = "";
    }

    function renderQuestionCard(q, index) {
        var html = "";
        html += '<div class="question-card">';
        html += '<h5>' + q.title + '</h5>';
        html += '<p>' + q.prompt + '</p>';
        html += '<div class="question-input">';
        html += '<label for="answer_' + index + '"><strong>Your answer:</strong></label>';
        html += '<input type="text" id="answer_' + index + '">';
        if (q.unitHint) {
            html += '<span>' + q.unitHint + '</span>';
        }
        html += '</div>';
        html += '<div id="feedback_' + index + '" class="feedback"></div>';
        html += '<div id="explain_' + index + '" class="step-explanation" style="display:none;"></div>';
        html += '</div>';
        return html;
    }

    function checkAnswers() {
        if (currentQuestions.length === 0) {
            alert("No questions to check. Generate questions first.");
            return;
        }

        var numCorrect = 0;

        for (var i = 0; i < currentQuestions.length; i++) {
            var q = currentQuestions[i];
            var ansInput = document.getElementById("answer_" + i);
            var feedbackEl = document.getElementById("feedback_" + i);
            var explainEl = document.getElementById("explain_" + i);

            if (!ansInput) continue;

            var userRaw = ansInput.value.trim();
            if (userRaw === "") {
                feedbackEl.textContent = "Please enter an answer.";
                feedbackEl.className = "feedback";
                explainEl.style.display = "none";
                continue;
            }

            if (q.type === "numeric") {
                var userVal = parseFloat(userRaw);
                if (isNaN(userVal)) {
                    feedbackEl.textContent = "Please enter a numeric answer.";
                    feedbackEl.className = "feedback";
                    explainEl.style.display = "none";
                    continue;
                }
                var correct = q.correctValue;
                var ok = isCloseNumeric(userVal, correct);
                if (ok) {
                    numCorrect++;
                    feedbackEl.textContent = "‚úÖ Correct (expected about " + correct.toFixed(3) + ").";
                    feedbackEl.className = "feedback correct";
                } else {
                    feedbackEl.textContent = "‚ùå Not quite. A good answer is about " + correct.toFixed(3) + ".";
                    feedbackEl.className = "feedback incorrect";
                }
            } else if (q.type === "open") {
                feedbackEl.textContent = "üìù Thanks for your explanation. Compare it with the expert interpretation below.";
                feedbackEl.className = "feedback";
            }

            explainEl.innerHTML = getExplanationHtml(q);
            explainEl.style.display = "block";
        }

        var interpLines = [];
        interpLines.push("‚Ä¢ You answered " + numCorrect + " out of " + currentQuestions.length + " auto-graded questions correctly (within tolerance).");
        interpLines.push("‚Ä¢ Remember: heteroskedasticity leaves Œ≤ÃÇ unchanged but affects standard errors, t-statistics, and confidence intervals. Robust SEs fix inference (asymptotically).");
        document.getElementById("interpretationDisplay").innerHTML =
            '<div class="interpretation-box"><h4>üß† Summary of This Practice Round</h4>' +
            interpLines.join("<br>") + '</div>';

        scenariosCompleted++;
        document.getElementById("scenariosCompleted").textContent = String(scenariosCompleted);
    }

    function isCloseNumeric(userVal, correctVal) {
        var diff = Math.abs(userVal - correctVal);
        var tol = Math.max(0.01, Math.abs(correctVal) * 0.03); // ¬±3% or at least 0.01
        return diff <= tol;
    }

    function getExplanationHtml(q) {
        if (!currentScenario) return "";

        var s = currentScenario;
        var html = "<strong>How to think about this:</strong><br>";

        var beta = s.betaHat;
        var seU = s.seUsual;
        var seR = s.seRobust;
        var tU = beta / seU;
        var tR = beta / seR;
        var ciU_low = beta - 1.96 * seU;
        var ciU_high = beta + 1.96 * seU;
        var ciR_low = beta - 1.96 * seR;
        var ciR_high = beta + 1.96 * seR;

        if (q.conceptId === "tUsual") {
            html += "The usual t-statistic uses the homoskedastic SE: t = Œ≤ÃÇ / se_usual.<br>";
            html += "Here, t_usual = " + beta.toFixed(3) + " / " + seU.toFixed(3) +
                    " = " + tU.toFixed(3) + ".<br>";
            html += "If |t| is greater than about 1.96, we would reject H‚ÇÄ: Œ≤ = 0 at the 5% level under the homoskedasticity assumption.";
        } else if (q.conceptId === "tRobust") {
            html += "The robust t-statistic uses the heteroskedasticity-robust SE: t = Œ≤ÃÇ / se_robust.<br>";
            html += "Here, t_robust = " + beta.toFixed(3) + " / " + seR.toFixed(3) +
                    " = " + tR.toFixed(3) + ".<br>";
            html += "If heteroskedasticity is present, this t_robust is the one we trust for inference.";
        } else if (q.conceptId === "ciUsualLow" || q.conceptId === "ciUsualHigh") {
            html += "A 95% CI (large-sample) is approximately Œ≤ÃÇ ¬± 1.96¬∑SE.<br>";
            html += "Using the usual SE:<br>";
            html += "Lower = " + beta.toFixed(3) + " ‚àí 1.96¬∑" + seU.toFixed(3) +
                    " = " + ciU_low.toFixed(3) + ".<br>";
            html += "Upper = " + beta.toFixed(3) + " + 1.96¬∑" + seU.toFixed(3) +
                    " = " + ciU_high.toFixed(3) + ".<br>";
            html += "If 0 is outside this interval, the coefficient is significant at the 5% level under homoskedasticity.";
        } else if (q.conceptId === "ciRobustLow" || q.conceptId === "ciRobustHigh") {
            html += "Using the robust SE, the 95% CI is Œ≤ÃÇ ¬± 1.96¬∑se_robust.<br>";
            html += "Lower (robust) = " + ciR_low.toFixed(3) + ", Upper (robust) = " + ciR_high.toFixed(3) + ".<br>";
            html += "Because se_robust is usually larger under heteroskedasticity, the robust interval is wider and may include 0 even when the usual interval does not.";
        } else if (q.conceptId === "interpret") {
            html += "<em>" + s.expertInterpretation + "</em>";
            html += "<br><br>Big picture: heteroskedasticity does not bias Œ≤ÃÇ, but it makes the usual standard errors unreliable. Robust SEs adjust for this and give more trustworthy t-tests and confidence intervals.";
        } else {
            html += "In general, compare t_usual and t_robust and their 95% CIs to see how heteroskedasticity affects the strength of evidence against H‚ÇÄ.";
        }

        return html;
    }

    function resetPractice() {
        currentScenario = null;
        currentQuestions = [];
        scenariosCompleted = 0;
        document.getElementById("scenariosCompleted").textContent = "0";
        document.getElementById("scenarioDisplay").style.display = "none";
        document.getElementById("calculationArea").style.display = "none";
        document.getElementById("questionsContainer").innerHTML = "";
        document.getElementById("interpretationDisplay").innerHTML = "";
        document.getElementById("dataDisplay").innerHTML = "";
        document.getElementById("scenarioDescription").innerHTML = "";
        console.log("Heteroskedasticity practice reset.");
    }

    document.getElementById("scenariosCompleted").textContent = "0";
</script>
</body>
</html>
