<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wooldridge Ch. 13: Difference-in-Differences & Policy Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Code+Pro:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <style>
        :root {
            --primary-green: #2E8B57;
            --secondary-red: #DC143C;
            --accent-darkblue: #1E3A8A;
            --light-green: #90EE90;
            --turquoise: #40E0D0;
            --neutral-lightgray: #F5F5F5;
            --background-cream: #FAFAFA;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #DC143C;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--background-cream) 0%, #E8F5E8 100%);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 50px rgba(46, 139, 87, 0.15);
            border-radius: 20px;
            overflow: hidden;
            animation: fadeInScale 1.2s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Header Design */
        .header-section {
            background: linear-gradient(135deg, var(--accent-darkblue) 0%, #1E40AF 100%);
            color: white;
            padding: 40px 30px;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(45deg) translate(50%, -50%);
        }

        .header-title {
            font-family: 'Playfair Display', serif;
            font-size: 3.2em;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .header-subtitle {
            font-size: 1.4em;
            font-weight: 300;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: var(--primary-green);
            padding: 0;
        }

        .tab-button {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .tab-button.active {
            color: white;
            background: rgba(255,255,255,0.2);
            border-bottom-color: var(--turquoise);
        }

        /* Content Sections */
        .content-section {
            display: none;
            padding: 40px;
            animation: slideInContent 0.6s ease-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes slideInContent {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Theory Framework */
        .theory-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .theory-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 15px;
            border-left: 5px solid var(--turquoise);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .theory-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.12);
        }

        .theory-card h3 {
            font-family: 'Playfair Display', serif;
            color: var(--secondary-red);
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        /* Mathematical Equations */
        .equation-display {
            background: var(--accent-darkblue);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Source Code Pro', monospace;
            font-size: 1.1em;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
            overflow-x: auto;
        }

        /* Interactive Controls */
        .control-panel {
            background: linear-gradient(135deg, #f1f3f4 0%, #e8eaed 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            border: 2px solid var(--turquoise);
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .form-group select,
        .form-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--turquoise);
            box-shadow: 0 0 10px rgba(64, 224, 208, 0.2);
        }

        /* Action Buttons */
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .btn-primary {
            background: var(--primary-green);
            color: white;
        }

        .btn-primary:hover {
            background: #3BA55C;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(46, 139, 87, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-red);
            color: white;
        }

        .btn-secondary:hover {
            background: #E63946;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 20, 60, 0.3);
        }

        /* Results Display */
        .results-container {
            background: white;
            border: 2px solid var(--primary-green);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .results-header {
            font-family: 'Playfair Display', serif;
            font-size: 1.8em;
            color: var(--secondary-red);
            margin-bottom: 20px;
            text-align: center;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Statistical Output */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .stat-value {
            font-family: 'Source Code Pro', monospace;
            font-size: 1.5em;
            font-weight: 600;
            color: var(--primary-green);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Decision Framework */
        .decision-panel {
            background: linear-gradient(135deg, #F0FFF0 0%, var(--light-green) 100%);
            border: 2px solid var(--primary-green);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
        }

        .decision-question {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--accent-darkblue);
        }

        .decision-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .decision-option {
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .decision-option:hover {
            border-color: var(--turquoise);
            background: #F0FFFF;
        }

        .decision-option.selected {
            border-color: var(--primary-green);
            background: #F0FFF0;
        }

        /* Feedback Messages */
        .feedback-message {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
        }

        .feedback-success {
            background: #F0FFF0;
            border: 2px solid var(--primary-green);
            color: #0D4A22;
        }

        .feedback-warning {
            background: #fff3cd;
            border: 2px solid var(--warning);
            color: #856404;
        }

        .feedback-danger {
            background: #FFE4E6;
            border: 2px solid var(--secondary-red);
            color: #721c24;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header-title {
                font-size: 2.2em;
            }

            .theory-grid {
                grid-template-columns: 1fr;
            }

            .control-group {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header-section">
            <h1 class="header-title">Wooldridge Ch. 13: Difference-in-Differences</h1>
            <p class="header-subtitle">Policy Analysis & Program Evaluation</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab-button active" onclick="showSection('theory')">üìö Theory Framework</button>
            <button class="tab-button" onclick="showSection('simulation')">üéØ Interactive Simulation</button>
            <button class="tab-button" onclick="showSection('analysis')">üìä Analysis & Results</button>
            <button class="tab-button" onclick="showSection('assessment')">‚úÖ Assessment Mode</button>
        </div>

        <!-- Theory Framework Section -->
        <div id="theory" class="content-section active">
            <h2 style="font-family: 'Playfair Display', serif; font-size: 2.5em; color: var(--secondary-red); margin-bottom: 30px; text-align: center;">Wooldridge Ch. 13: Policy Analysis with DiD</h2>
            
            <div class="theory-grid">
                <div class="theory-card">
                    <h3>üéØ The Basic 2√ó2 DiD Design</h3>
                    <p><strong>Wooldridge Setup:</strong> Two groups (treatment/control), two time periods (before/after policy). The policy affects only the treatment group in the second period.</p>
                    <div class="equation-display">
                        DiD_estimate = (»≥_T,after - »≥_T,before) - (»≥_C,after - »≥_C,before)
                    </div>
                    <p><em>This removes both time-invariant group differences and common time trends</em></p>
                </div>

                <div class="theory-card">
                    <h3>üîÑ Parallel Trends Assumption</h3>
                    <p><strong>Wooldridge Identification:</strong> "In the absence of treatment, the unobserved differences between treatment and control groups are constant over time."</p>
                    <div class="equation-display">
                        E[Œ¥_t | d_i = 1] = E[Œ¥_t | d_i = 0] for all t
                    </div>
                    <p><em>Where Œ¥_t captures time-varying unobservables</em></p>
                </div>

                <div class="theory-card">
                    <h3>üìä Wooldridge Regression Framework</h3>
                    <p><strong>Standard Specification:</strong> Pooled OLS on panel data with interaction term</p>
                    <div class="equation-display">
                        y = Œ≤‚ÇÄ + Œ¥‚ÇÄd2 + Œ≤‚ÇÅdT + Œ¥‚ÇÅ(d2 √ó dT) + u
                    </div>
                    <p><strong>Where:</strong> d2 = second time period, dT = treatment group, Œ¥‚ÇÅ = <strong>DiD estimate</strong></p>
                </div>

                <div class="theory-card">
                    <h3>üßÆ Adding Controls (Wooldridge Extension)</h3>
                    <p><strong>More General Model:</strong> Include time-varying covariates for efficiency and robustness</p>
                    <div class="equation-display">
                        y = Œ≤‚ÇÄ + Œ¥‚ÇÄd2 + Œ≤‚ÇÅdT + Œ¥‚ÇÅ(d2 √ó dT) + Œ≤‚ÇÇX + u
                    </div>
                    <p><strong>Key:</strong> Controls must not be affected by treatment (bad controls problem)</p>
                </div>
            </div>

            <div class="theory-card" style="grid-column: 1 / -1;">
                <h3>‚ö†Ô∏è Wooldridge Warnings & Extensions</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <div>
                        <h4>üö´ Common Mistakes:</h4>
                        <ul>
                            <li><strong>Bad Controls:</strong> Including post-treatment variables</li>
                            <li><strong>Anticipation Effects:</strong> Behavior changes before treatment</li>
                            <li><strong>Composition Changes:</strong> Different units over time</li>
                            <li><strong>Spillovers:</strong> Treatment affects control group</li>
                        </ul>
                    </div>
                    <div>
                        <h4>üìà Extensions & Robustness:</h4>
                        <ul>
                            <li><strong>Multiple Time Periods:</strong> Two-way fixed effects</li>
                            <li><strong>Multiple Treatment Timing:</strong> Staggered adoption</li>
                            <li><strong>Clustered Standard Errors:</strong> Within-group correlation</li>
                            <li><strong>Event Studies:</strong> Dynamic treatment effects</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="theory-card" style="grid-column: 1 / -1;">
                <h3>üá®üá¶ Wooldridge-Style Canadian Applications</h3>
                <p><strong>Classic Policy Evaluation Examples:</strong></p>
                <ul style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <li><strong>Minimum Wage:</strong> Employment effects across provinces</li>
                    <li><strong>Healthcare:</strong> Public insurance expansion outcomes</li>
                    <li><strong>Education:</strong> School funding increases and test scores</li>
                    <li><strong>Training Programs:</strong> Employment and earnings impacts</li>
                    <li><strong>Environmental Policy:</strong> Carbon tax effectiveness</li>
                    <li><strong>Housing Policy:</strong> Rent control effects on supply</li>
                </ul>
            </div>
        </div>

        <!-- Interactive Simulation Section -->
        <div id="simulation" class="content-section">
            <h2 style="font-family: 'Playfair Display', serif; font-size: 2.5em; color: var(--secondary-red); margin-bottom: 30px; text-align: center;">Interactive DiD Simulation</h2>

            <div class="control-panel">
                <h3 style="margin-bottom: 20px; color: var(--text-primary);">üéõÔ∏è Scenario Configuration</h3>
                
                <div class="control-group">
                    <div class="form-group">
                        <label for="policyType">Policy Scenario</label>
                        <select id="policyType" onchange="updateScenario()">
                            <option value="healthcare">Healthcare Expansion (Ontario)</option>
                            <option value="education">School Funding Reform (Quebec)</option>
                            <option value="labour">Minimum Wage Increase (BC)</option>
                            <option value="environment">Carbon Tax Implementation (Federal)</option>
                            <option value="housing">Rent Control Policy (Toronto)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="functionalForm">Functional Form</label>
                        <select id="functionalForm" onchange="updateModel()">
                            <option value="additive">Additive (Linear Effects)</option>
                            <option value="multiplicative">Multiplicative (Log-Linear)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="treatmentEffect">True Treatment Effect</label>
                        <input type="range" id="treatmentEffect" min="-50" max="50" value="15" onchange="updateSimulation()">
                        <span id="effectValue">15%</span>
                    </div>

                    <div class="form-group">
                        <label for="parallelTrends">Parallel Trends Violation</label>
                        <input type="range" id="parallelTrends" min="0" max="20" value="0" onchange="updateSimulation()">
                        <span id="trendsValue">0% (Valid)</span>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="generateData()">üé≤ Generate New Data</button>
                    <button class="btn btn-secondary" onclick="runRegression()">üìä Run DiD Regression</button>
                </div>
            </div>

            <!-- Chart Display -->
            <div class="chart-container">
                <canvas id="didChart"></canvas>
            </div>

            <!-- Current Scenario Display -->
            <div id="scenarioDescription" class="results-container">
                <div class="results-header">Current Scenario</div>
                <div id="scenarioText"></div>
            </div>
        </div>

        <!-- Analysis & Results Section -->
        <div id="analysis" class="content-section">
            <h2 style="font-family: 'Playfair Display', serif; font-size: 2.5em; color: var(--secondary-red); margin-bottom: 30px; text-align: center;">DiD Analysis Results</h2>

            <div id="regressionResults" class="results-container">
                <div class="results-header">Regression Output</div>
                <div id="regressionTable"></div>
            </div>

            <div class="stats-grid" id="statisticsDisplay">
                <!-- Dynamic statistics will be populated here -->
            </div>

            <div id="diagnostics" class="results-container">
                <div class="results-header">üîç Diagnostic Tests</div>
                <div id="diagnosticResults"></div>
            </div>

            <!-- Event Study Plot -->
            <div class="chart-container">
                <h3 style="text-align: center; margin-bottom: 20px;">Event Study Analysis</h3>
                <canvas id="eventStudyChart"></canvas>
            </div>
        </div>

        <!-- Assessment Mode Section -->
        <div id="assessment" class="content-section">
            <h2 style="font-family: 'Playfair Display', serif; font-size: 2.5em; color: var(--secondary-red); margin-bottom: 30px; text-align: center;">Assessment Challenge</h2>

            <div id="assessmentQuestion" class="decision-panel">
                <div class="decision-question">Loading assessment question...</div>
                <div class="decision-options" id="assessmentOptions">
                    <!-- Dynamic options will be populated -->
                </div>
                <button class="btn btn-primary" onclick="checkAnswer()" style="margin-top: 20px;">Submit Answer</button>
            </div>

            <div id="assessmentFeedback"></div>

            <div class="button-group" style="margin-top: 30px;">
                <button class="btn btn-secondary" onclick="generateNewQuestion()">üìù New Question</button>
                <button class="btn btn-primary" onclick="showExpertSolution()">üéì Show Expert Solution</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentData = null;
        let currentChart = null;
        let eventStudyChart = null;
        let selectedAnswer = null;
        let currentQuestion = null;

        // Policy Scenarios (Wooldridge-style applications)
        const scenarios = {
            healthcare: {
                title: "Healthcare Expansion Study (Wooldridge-style)",
                description: "Following Wooldridge Ch. 13 approach: Analyzing expanded public healthcare coverage effects on emergency room utilization. Treatment group (Ontario) vs Control group (other provinces), before/after policy implementation.",
                outcome: "Emergency Room Visits per 1000 residents",
                treatment: "Ontario (dT = 1)",
                control: "Other provinces (dT = 0)",
                baseline: 45,
                timeFrame: "Before: 2018-2019, After: 2020-2021 (d2 = 1)",
                wooldridgeNote: "Classic 2√ó2 design: Œ¥‚ÇÅ measures policy impact"
            },
            education: {
                title: "Education Funding Reform (Wooldridge Application)", 
                description: "Wooldridge Ch. 13 framework: Evaluating per-pupil funding increases on standardized test performance. Quebec schools (treatment) vs other provinces (control).",
                outcome: "Average Math Test Scores",
                treatment: "Quebec schools (dT = 1)",
                control: "Schools in other provinces (dT = 0)",
                baseline: 72,
                timeFrame: "Before: 2019-2020, After: 2021-2022 (d2 = 1)",
                wooldridgeNote: "Parallel trends: Same test score trends absent policy"
            },
            labour: {
                title: "Minimum Wage Policy Evaluation (Ch. 13 Example)",
                description: "Wooldridge-style analysis: BC minimum wage increase effects on employment. Treatment/control comparison following Ch. 13 methodology.",
                outcome: "Employment Rate (%)",
                treatment: "British Columbia (dT = 1)",
                control: "Alberta & Saskatchewan (dT = 0)",
                baseline: 62,
                timeFrame: "Before: 2017-2018, After: 2019-2020 (d2 = 1)", 
                wooldridgeNote: "Key assumption: Parallel employment trends"
            },
            environment: {
                title: "Carbon Tax Implementation (Wooldridge Policy Analysis)",
                description: "Following Ch. 13: Federal carbon tax effectiveness on provincial CO2 emissions. Newly covered provinces vs provinces with existing pricing.",
                outcome: "CO2 Emissions (tonnes per capita)",
                treatment: "Newly covered provinces (dT = 1)",
                control: "Provinces with existing pricing (dT = 0)",
                baseline: 18.5,
                timeFrame: "Before: 2016-2017, After: 2019-2020 (d2 = 1)",
                wooldridgeNote: "Treatment group gets new federal policy"
            },
            housing: {
                title: "Rent Control Policy Study (Ch. 13 Framework)",
                description: "Wooldridge methodology: Toronto rent control expansion effects on housing supply. City comparison using DiD identification strategy.",
                outcome: "New Housing Units (per 1000 residents)",
                treatment: "Toronto (dT = 1)",
                control: "Vancouver & Montreal (dT = 0)",
                baseline: 8.2,
                timeFrame: "Before: 2020-2021, After: 2022-2023 (d2 = 1)",
                wooldridgeNote: "Policy affects only treatment city in period 2"
            }
        };

        // Assessment Questions Bank (Wooldridge Ch. 13 focused)
        const assessmentQuestions = [
            {
                question: "In Wooldridge's basic DiD model y = Œ≤‚ÇÄ + Œ¥‚ÇÄd2 + Œ≤‚ÇÅdT + Œ¥‚ÇÅ(d2√ódT) + u, what does Œ¥‚ÇÅ represent?",
                options: [
                    "The pre-treatment difference between groups",
                    "The time trend affecting all units", 
                    "The difference-in-differences estimate",
                    "The baseline outcome for the control group"
                ],
                correct: 2,
                explanation: "Œ¥‚ÇÅ is the coefficient on the interaction term (d2√ódT), which captures the DiD estimate - the treatment effect we're trying to identify."
            },
            {
                question: "According to Wooldridge, what is the key identifying assumption for DiD?",
                options: [
                    "Treatment assignment is random",
                    "Parallel trends in absence of treatment", 
                    "No spillover effects between groups",
                    "Homoscedastic error terms"
                ],
                correct: 1,
                explanation: "Wooldridge emphasizes that parallel trends - constant unobserved differences between groups over time - is the crucial assumption for DiD identification."
            },
            {
                question: "In Wooldridge's 2√ó2 DiD setup, why do we need TWO differences?",
                options: [
                    "To control for measurement error",
                    "To remove both group differences and time trends",
                    "To increase statistical power",
                    "To satisfy normality assumptions"
                ],
                correct: 1,
                explanation: "The first difference removes time-invariant group differences, the second removes common time trends, leaving only the treatment effect."
            },
            {
                question: "Wooldridge warns against 'bad controls' in DiD. Which would be a bad control?",
                options: [
                    "Pre-treatment characteristics of individuals",
                    "Geographic fixed effects",
                    "Outcomes affected by the treatment itself",
                    "Time-invariant demographic variables"
                ],
                correct: 2,
                explanation: "Bad controls are variables affected by treatment. Including them can bias the DiD estimate by capturing part of the treatment effect."
            },
            {
                question: "Why does Wooldridge recommend clustering standard errors in DiD applications?",
                options: [
                    "To correct for heteroskedasticity",
                    "To account for correlation within groups over time",
                    "To improve coefficient estimates",
                    "To satisfy normality assumptions"
                ],
                correct: 1,
                explanation: "Panel data typically has correlation within units over time, violating independence. Clustering corrects standard errors for this dependence."
            }
        ];

        // Navigation Functions
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section and activate tab
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');
        }

        // Scenario Management
        function updateScenario() {
            const policyType = document.getElementById('policyType').value;
            const scenario = scenarios[policyType];
            
            document.getElementById('scenarioText').innerHTML = `
                <h3 style="color: var(--secondary-red); margin-bottom: 15px;">${scenario.title}</h3>
                <p><strong>Research Question:</strong> ${scenario.description}</p>
                <div style="background: #F0F8FF; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--primary-green);">
                    <p><strong>üéì Wooldridge Methodology:</strong> ${scenario.wooldridgeNote}</p>
                </div>
                <p><strong>Outcome Variable (y):</strong> ${scenario.outcome}</p>
                <p><strong>Treatment Group:</strong> ${scenario.treatment}</p>
                <p><strong>Control Group:</strong> ${scenario.control}</p>
                <p><strong>Time Periods:</strong> ${scenario.timeFrame}</p>
                <p><strong>Baseline Level:</strong> ${scenario.baseline}</p>
                <div style="background: #FFF8DC; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <p><strong>üìä Wooldridge Model:</strong> y = Œ≤‚ÇÄ + Œ¥‚ÇÄd2 + Œ≤‚ÇÅdT + Œ¥‚ÇÅ(d2√ódT) + u</p>
                    <p><em>Where Œ¥‚ÇÅ is our DiD estimate of the treatment effect</em></p>
                </div>
            `;
            
            updateSimulation();
        }

        function updateModel() {
            updateSimulation();
        }

        function updateSimulation() {
            const effectSlider = document.getElementById('treatmentEffect');
            const trendsSlider = document.getElementById('parallelTrends');
            
            document.getElementById('effectValue').textContent = effectSlider.value + '%';
            
            const trendsViolation = parseInt(trendsSlider.value);
            document.getElementById('trendsValue').textContent = 
                trendsViolation === 0 ? '0% (Valid)' : `${trendsViolation}% (Violation)`;
            
            if (currentData) {
                generateData();
            }
        }

        // Data Generation
        function generateData() {
            const policyType = document.getElementById('policyType').value;
            const scenario = scenarios[policyType];
            const functionalForm = document.getElementById('functionalForm').value;
            const treatmentEffect = parseFloat(document.getElementById('treatmentEffect').value);
            const trendsViolation = parseFloat(document.getElementById('parallelTrends').value);
            
            // Generate synthetic data
            const n = 100; // 50 treatment, 50 control
            const timePoints = 8; // 4 pre, 4 post
            
            currentData = {
                units: [],
                timePoints: timePoints,
                treatmentTime: 4,
                scenario: scenario,
                functionalForm: functionalForm,
                trueEffect: treatmentEffect,
                trendsViolation: trendsViolation
            };

            // Generate data for each unit
            for (let i = 0; i < n; i++) {
                const isTreated = i < n/2;
                const unit = {
                    id: i + 1,
                    treated: isTreated,
                    observations: []
                };

                for (let t = 0; t < timePoints; t++) {
                    const isPost = t >= 4;
                    const baseLevel = scenario.baseline;
                    
                    // Add noise and trends
                    const noise = (Math.random() - 0.5) * 10;
                    const timeTrend = t * 0.5;
                    const groupTrend = isTreated ? t * (trendsViolation / 100) : 0;
                    
                    let outcome = baseLevel + timeTrend + groupTrend + noise;
                    
                    // Add treatment effect for treated units in post period
                    if (isTreated && isPost) {
                        if (functionalForm === 'additive') {
                            outcome += treatmentEffect;
                        } else { // multiplicative
                            outcome *= (1 + treatmentEffect / 100);
                        }
                    }
                    
                    unit.observations.push({
                        time: t,
                        isPost: isPost,
                        outcome: Math.max(outcome, 0), // Ensure non-negative
                        logOutcome: Math.log(Math.max(outcome, 0.1))
                    });
                }
                
                currentData.units.push(unit);
            }

            // Update chart
            updateChart();
        }

        // Chart Updates
        function updateChart() {
            if (!currentData) return;
            
            // Calculate group means by time period
            const treatmentMeans = [];
            const controlMeans = [];
            const timeLabels = [];
            
            for (let t = 0; t < currentData.timePoints; t++) {
                const treatmentObs = currentData.units
                    .filter(u => u.treated)
                    .map(u => u.observations[t].outcome);
                const controlObs = currentData.units
                    .filter(u => !u.treated)
                    .map(u => u.observations[t].outcome);
                
                treatmentMeans.push(treatmentObs.reduce((a,b) => a+b, 0) / treatmentObs.length);
                controlMeans.push(controlObs.reduce((a,b) => a+b, 0) / controlObs.length);
                timeLabels.push(`Period ${t + 1}`);
            }

            const ctx = document.getElementById('didChart').getContext('2d');
            
            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
            }

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Treatment Group',
                        data: treatmentMeans,
                        borderColor: '#2E8B57',
                        backgroundColor: 'rgba(46, 139, 87, 0.1)',
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }, {
                        label: 'Control Group',
                        data: controlMeans,
                        borderColor: '#40E0D0',
                        backgroundColor: 'rgba(64, 224, 208, 0.1)',
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${currentData.scenario.title} - Time Series`,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: currentData.scenario.outcome
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time Period'
                            }
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    xMin: 3.5,
                                    xMax: 3.5,
                                    borderColor: 'rgba(220, 20, 60, 0.8)',
                                    borderWidth: 2,
                                    label: {
                                        content: 'Policy Implementation',
                                        enabled: true
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // Regression Analysis
        function runRegression() {
            if (!currentData) {
                alert('Please generate data first');
                return;
            }

            // Prepare regression data
            const observations = [];
            currentData.units.forEach(unit => {
                unit.observations.forEach(obs => {
                    observations.push({
                        outcome: currentData.functionalForm === 'multiplicative' ? obs.logOutcome : obs.outcome,
                        treated: unit.treated ? 1 : 0,
                        post: obs.isPost ? 1 : 0,
                        interaction: (unit.treated && obs.isPost) ? 1 : 0,
                        time: obs.time
                    });
                });
            });

            // Simple OLS calculation for DiD
            const n = observations.length;
            let sumY = 0, sumTreat = 0, sumPost = 0, sumInteraction = 0;
            let sumTreatY = 0, sumPostY = 0, sumInteractionY = 0;
            
            observations.forEach(obs => {
                sumY += obs.outcome;
                sumTreat += obs.treated;
                sumPost += obs.post;
                sumInteraction += obs.interaction;
                sumTreatY += obs.treated * obs.outcome;
                sumPostY += obs.post * obs.outcome;
                sumInteractionY += obs.interaction * obs.outcome;
            });

            // Calculate group means for DiD
            const preControl = observations.filter(o => !o.treated && !o.post).map(o => o.outcome);
            const preControlMean = preControl.reduce((a,b) => a+b, 0) / preControl.length;
            
            const postControl = observations.filter(o => !o.treated && o.post).map(o => o.outcome);
            const postControlMean = postControl.reduce((a,b) => a+b, 0) / postControl.length;
            
            const preTreatment = observations.filter(o => o.treated && !o.post).map(o => o.outcome);
            const preTreatmentMean = preTreatment.reduce((a,b) => a+b, 0) / preTreatment.length;
            
            const postTreatment = observations.filter(o => o.treated && o.post).map(o => o.outcome);
            const postTreatmentMean = postTreatment.reduce((a,b) => a+b, 0) / postTreatment.length;

            // Calculate DiD estimate
            const didEstimate = (postTreatmentMean - preTreatmentMean) - (postControlMean - preControlMean);
            
            // Calculate standard error (simplified)
            const residuals = observations.map(obs => {
                let predicted = preControlMean + 
                               (preTreatmentMean - preControlMean) * obs.treated +
                               (postControlMean - preControlMean) * obs.post +
                               didEstimate * obs.interaction;
                return obs.outcome - predicted;
            });
            
            const mse = residuals.map(r => r*r).reduce((a,b) => a+b, 0) / (n - 4);
            const standardError = Math.sqrt(mse / (n/4)); // Simplified
            
            const tStat = didEstimate / standardError;
            const pValue = 2 * (1 - normalCDF(Math.abs(tStat)));

            // Display results
            displayRegressionResults({
                didEstimate,
                standardError,
                tStat,
                pValue,
                preControlMean,
                postControlMean,
                preTreatmentMean,
                postTreatmentMean,
                trueEffect: currentData.trueEffect,
                functionalForm: currentData.functionalForm
            });
        }

        // Helper function for normal CDF approximation
        function normalCDF(x) {
            return 0.5 * (1 + Math.sign(x) * Math.sqrt(1 - Math.exp(-2 * x * x / Math.PI)));
        }

        // Display regression results
        function displayRegressionResults(results) {
            const isSignificant = results.pValue < 0.05;
            const significanceClass = isSignificant ? 'feedback-success' : 'feedback-warning';
            
            document.getElementById('regressionTable').innerHTML = `
                <h4>Wooldridge Ch. 13 DiD Regression Results</h4>
                <div style="font-family: 'Source Code Pro', monospace; background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; font-weight: 600; border-bottom: 2px solid #ddd; padding-bottom: 10px;">
                        <div>Variable</div>
                        <div>Coefficient</div>
                        <div>Std. Error</div>
                        <div>P-value</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; padding: 10px 0;">
                        <div>Constant (Œ≤‚ÇÄ)</div>
                        <div>${results.preControlMean.toFixed(3)}</div>
                        <div>-</div>
                        <div>-</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; padding: 10px 0;">
                        <div>Treatment Group (Œ≤‚ÇÅ)</div>
                        <div>${(results.preTreatmentMean - results.preControlMean).toFixed(3)}</div>
                        <div>-</div>
                        <div>-</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; padding: 10px 0;">
                        <div>Time Period 2 (Œ¥‚ÇÄ)</div>
                        <div>${(results.postControlMean - results.preControlMean).toFixed(3)}</div>
                        <div>-</div>
                        <div>-</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; padding: 10px 0; background: rgba(46, 139, 87, 0.1); font-weight: 700;">
                        <div>DiD Estimate (Œ¥‚ÇÅ)</div>
                        <div>${results.didEstimate.toFixed(3)}</div>
                        <div>${results.standardError.toFixed(3)}</div>
                        <div>${results.pValue.toFixed(3)}</div>
                    </div>
                </div>
                <div style="background: #F0F8FF; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <p><strong>üéì Wooldridge Interpretation:</strong> Œ¥‚ÇÅ = ${results.didEstimate.toFixed(3)} is the causal effect of the policy intervention.</p>
                    <p><em>Model: y = Œ≤‚ÇÄ + Œ¥‚ÇÄd2 + Œ≤‚ÇÅdT + Œ¥‚ÇÅ(d2√ódT) + u</em></p>
                </div>
            `;

            // Update statistics display
            document.getElementById('statisticsDisplay').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${results.didEstimate.toFixed(2)}</div>
                    <div class="stat-label">DiD Estimate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${results.trueEffect.toFixed(2)}</div>
                    <div class="stat-label">True Effect</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.abs(results.didEstimate - results.trueEffect).toFixed(2)}</div>
                    <div class="stat-label">Estimation Error</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${results.tStat.toFixed(2)}</div>
                    <div class="stat-label">T-Statistic</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(results.pValue * 100).toFixed(1)}%</div>
                    <div class="stat-label">P-Value</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${isSignificant ? '‚úì' : '‚úó'}</div>
                    <div class="stat-label">Significant (5%)</div>
                </div>
            `;

            // Display diagnostics
            displayDiagnostics(results);
        }

        // Display diagnostic tests
        function displayDiagnostics(results) {
            const bias = Math.abs(results.didEstimate - results.trueEffect);
            const biasPercent = Math.abs(bias / results.trueEffect) * 100;
            
            let biasAssessment = '';
            if (biasPercent < 5) biasAssessment = '‚úì Excellent';
            else if (biasPercent < 15) biasAssessment = '‚ö† Acceptable';
            else biasAssessment = '‚úó Concerning';

            document.getElementById('diagnosticResults').innerHTML = `
                <h4>Model Diagnostics</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div class="stat-card">
                        <h5>Estimation Accuracy</h5>
                        <p><strong>Bias:</strong> ${bias.toFixed(3)}</p>
                        <p><strong>Bias %:</strong> ${biasPercent.toFixed(1)}%</p>
                        <p><strong>Assessment:</strong> ${biasAssessment}</p>
                    </div>
                    <div class="stat-card">
                        <h5>Statistical Power</h5>
                        <p><strong>T-statistic:</strong> ${results.tStat.toFixed(2)}</p>
                        <p><strong>Significance:</strong> ${results.pValue < 0.05 ? 'Yes' : 'No'}</p>
                        <p><strong>Power:</strong> ${results.pValue < 0.05 ? 'Adequate' : 'Low'}</p>
                    </div>
                </div>
                <div class="${results.pValue < 0.05 ? 'feedback-success' : 'feedback-warning'}">
                    <strong>Interpretation:</strong> 
                    ${results.functionalForm === 'multiplicative' 
                        ? `The treatment has a ${(Math.exp(results.didEstimate) - 1) * 100 > 0 ? 'positive' : 'negative'} effect of ${Math.abs((Math.exp(results.didEstimate) - 1) * 100).toFixed(1)}% on the outcome.`
                        : `The treatment causes a ${results.didEstimate > 0 ? 'increase' : 'decrease'} of ${Math.abs(results.didEstimate).toFixed(2)} units in the outcome.`
                    }
                    ${results.pValue < 0.05 ? 'This effect is statistically significant.' : 'This effect is not statistically significant.'}
                </div>
            `;
        }

        // Assessment Functions
        function generateNewQuestion() {
            currentQuestion = assessmentQuestions[Math.floor(Math.random() * assessmentQuestions.length)];
            selectedAnswer = null;
            
            document.querySelector('.decision-question').textContent = currentQuestion.question;
            
            const optionsContainer = document.getElementById('assessmentOptions');
            optionsContainer.innerHTML = '';
            
            currentQuestion.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'decision-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(optionDiv);
            });
            
            document.getElementById('assessmentFeedback').innerHTML = '';
        }

        function selectAnswer(answerIndex) {
            selectedAnswer = answerIndex;
            
            document.querySelectorAll('.decision-option').forEach((option, index) => {
                option.classList.toggle('selected', index === answerIndex);
            });
        }

        function checkAnswer() {
            if (selectedAnswer === null) {
                alert('Please select an answer first');
                return;
            }
            
            const isCorrect = selectedAnswer === currentQuestion.correct;
            const feedbackClass = isCorrect ? 'feedback-success' : 'feedback-danger';
            const feedbackTitle = isCorrect ? '‚úì Correct!' : '‚úó Incorrect';
            
            document.getElementById('assessmentFeedback').innerHTML = `
                <div class="${feedbackClass}">
                    <h4>${feedbackTitle}</h4>
                    <p><strong>Explanation:</strong> ${currentQuestion.explanation}</p>
                    <p><strong>Correct Answer:</strong> ${currentQuestion.options[currentQuestion.correct]}</p>
                </div>
            `;
        }

        function showExpertSolution() {
            if (!currentQuestion) {
                generateNewQuestion();
                return;
            }
            
            document.getElementById('assessmentFeedback').innerHTML = `
                <div class="feedback-success">
                    <h4>üéì Expert Solution</h4>
                    <p><strong>Correct Answer:</strong> ${currentQuestion.options[currentQuestion.correct]}</p>
                    <p><strong>Expert Reasoning:</strong> ${currentQuestion.explanation}</p>
                    <p><strong>Key Learning:</strong> Understanding this concept is crucial for proper DiD implementation and avoiding common pitfalls in causal inference.</p>
                </div>
            `;
        }

        // Initialize page
        window.addEventListener('load', function() {
            updateScenario();
            generateData();
            generateNewQuestion();
        });
    </script>
</body>
</html>
